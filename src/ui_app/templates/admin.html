{% extends "base.html" %}
{% block content %}
<section class="grid">
  <article class="card">
    <header>
      <h2>System Administration</h2>
    </header>
    
    <!-- System Overview -->
    <details open>
      <summary>System Overview</summary>
      
      <div class="overview-section">
        <div class="system-stats">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">{{ system_stats.active_services if system_stats else '0' }}</div>
              <div class="stat-label">Active Services</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-value">{{ system_stats.total_certificates if system_stats else '0' }}</div>
              <div class="stat-label">Total Certificates</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-value">{{ system_stats.documents_processed if system_stats else '0' }}</div>
              <div class="stat-label">Documents Processed</div>
            </div>
            
            <div class="stat-card">
              <div class="stat-value">{{ system_stats.system_uptime if system_stats else '0h' }}</div>
              <div class="stat-label">System Uptime</div>
            </div>
          </div>
        </div>
        
        <!-- Quick Health Check -->
        <div class="health-overview">
          <h4>System Health</h4>
          <div class="health-indicators">
            {% if health_status %}
              {% for service, status in health_status.items() %}
                <div class="health-indicator">
                  <div class="health-dot health-{{ status.status|lower }}"></div>
                  <span class="service-name">{{ service.replace('_', ' ').title() }}</span>
                  <span class="response-time">{{ status.response_time }}ms</span>
                </div>
              {% endfor %}
            {% else %}
              <p>No health data available. Click "Refresh Status" to check system health.</p>
            {% endif %}
          </div>
          <button class="button" onclick="refreshSystemHealth()">Refresh Status</button>
        </div>
      </div>
    </details>
    
    <!-- Service Management -->
    <details>
      <summary>Service Management</summary>
      
      <div class="service-management-section">
        <div class="services-grid">
          <!-- CSCA Service -->
          <div class="service-card">
            <div class="service-header">
              <h5>CSCA Service</h5>
              <div class="service-status status-{{ services.csca.status|lower if services else 'unknown' }}">
                {{ services.csca.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.csca %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.csca.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.csca.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.csca.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.csca.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('csca', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('csca', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('csca', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('csca')">Logs</button>
            </div>
          </div>
          
          <!-- Document Signer Service -->
          <div class="service-card">
            <div class="service-header">
              <h5>Document Signer</h5>
              <div class="service-status status-{{ services.document_signer.status|lower if services else 'unknown' }}">
                {{ services.document_signer.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.document_signer %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.document_signer.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.document_signer.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.document_signer.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.document_signer.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('document_signer', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('document_signer', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('document_signer', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('document_signer')">Logs</button>
            </div>
          </div>
          
          <!-- Passport Engine -->
          <div class="service-card">
            <div class="service-header">
              <h5>Passport Engine</h5>
              <div class="service-status status-{{ services.passport_engine.status|lower if services else 'unknown' }}">
                {{ services.passport_engine.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.passport_engine %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.passport_engine.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.passport_engine.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.passport_engine.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.passport_engine.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('passport_engine', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('passport_engine', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('passport_engine', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('passport_engine')">Logs</button>
            </div>
          </div>
          
          <!-- Inspection System -->
          <div class="service-card">
            <div class="service-header">
              <h5>Inspection System</h5>
              <div class="service-status status-{{ services.inspection_system.status|lower if services else 'unknown' }}">
                {{ services.inspection_system.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.inspection_system %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.inspection_system.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.inspection_system.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.inspection_system.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.inspection_system.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('inspection_system', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('inspection_system', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('inspection_system', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('inspection_system')">Logs</button>
            </div>
          </div>
          
          <!-- MDL Engine -->
          <div class="service-card">
            <div class="service-header">
              <h5>MDL Engine</h5>
              <div class="service-status status-{{ services.mdl_engine.status|lower if services else 'unknown' }}">
                {{ services.mdl_engine.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.mdl_engine %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.mdl_engine.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.mdl_engine.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.mdl_engine.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.mdl_engine.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('mdl_engine', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('mdl_engine', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('mdl_engine', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('mdl_engine')">Logs</button>
            </div>
          </div>
          
          <!-- mDoc Engine -->
          <div class="service-card">
            <div class="service-header">
              <h5>mDoc Engine</h5>
              <div class="service-status status-{{ services.mdoc_engine.status|lower if services else 'unknown' }}">
                {{ services.mdoc_engine.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.mdoc_engine %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.mdoc_engine.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.mdoc_engine.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.mdoc_engine.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.mdoc_engine.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('mdoc_engine', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('mdoc_engine', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('mdoc_engine', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('mdoc_engine')">Logs</button>
            </div>
          </div>
          
          <!-- DTC Engine -->
          <div class="service-card">
            <div class="service-header">
              <h5>DTC Engine</h5>
              <div class="service-status status-{{ services.dtc_engine.status|lower if services else 'unknown' }}">
                {{ services.dtc_engine.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.dtc_engine %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.dtc_engine.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.dtc_engine.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.dtc_engine.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.dtc_engine.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('dtc_engine', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('dtc_engine', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('dtc_engine', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('dtc_engine')">Logs</button>
            </div>
          </div>
          
          <!-- PKD Service -->
          <div class="service-card">
            <div class="service-header">
              <h5>PKD Service</h5>
              <div class="service-status status-{{ services.pkd_service.status|lower if services else 'unknown' }}">
                {{ services.pkd_service.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.pkd_service %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.pkd_service.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.pkd_service.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.pkd_service.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.pkd_service.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('pkd_service', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('pkd_service', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('pkd_service', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('pkd_service')">Logs</button>
            </div>
          </div>
          
          <!-- Trust Anchor -->
          <div class="service-card">
            <div class="service-header">
              <h5>Trust Anchor</h5>
              <div class="service-status status-{{ services.trust_anchor.status|lower if services else 'unknown' }}">
                {{ services.trust_anchor.status if services else 'Unknown' }}
              </div>
            </div>
            
            <div class="service-details">
              {% if services and services.trust_anchor %}
                <dl>
                  <dt>Port:</dt><dd>{{ services.trust_anchor.port }}</dd>
                  <dt>Memory:</dt><dd>{{ services.trust_anchor.memory_usage }}</dd>
                  <dt>CPU:</dt><dd>{{ services.trust_anchor.cpu_usage }}</dd>
                  <dt>Uptime:</dt><dd>{{ services.trust_anchor.uptime }}</dd>
                </dl>
              {% endif %}
            </div>
            
            <div class="service-actions">
              <button class="button button-small" onclick="serviceAction('trust_anchor', 'start')">Start</button>
              <button class="button button-small" onclick="serviceAction('trust_anchor', 'stop')">Stop</button>
              <button class="button button-small" onclick="serviceAction('trust_anchor', 'restart')">Restart</button>
              <button class="button button-small" onclick="viewServiceLogs('trust_anchor')">Logs</button>
            </div>
          </div>
        </div>
        
        <!-- Bulk Service Actions -->
        <div class="bulk-actions">
          <h4>Bulk Service Operations</h4>
          <div class="bulk-controls">
            <button class="button" onclick="bulkServiceAction('start_all')">Start All Services</button>
            <button class="button" onclick="bulkServiceAction('stop_all')">Stop All Services</button>
            <button class="button" onclick="bulkServiceAction('restart_all')">Restart All Services</button>
            <button class="button" onclick="bulkServiceAction('reload_config')">Reload Configurations</button>
          </div>
        </div>
      </div>
    </details>
    
    <!-- System Configuration -->
    <details>
      <summary>System Configuration</summary>
      
      <div class="configuration-section">
        <!-- Environment Settings -->
        <div class="config-subsection">
          <h4>Environment Configuration</h4>
          <form method="post" action="/admin/update-config">
            <div class="config-tabs">
              <div class="tab-buttons">
                <button type="button" class="tab-button active" onclick="showConfigTab('general')">General</button>
                <button type="button" class="tab-button" onclick="showConfigTab('security')">Security</button>
                <button type="button" class="tab-button" onclick="showConfigTab('logging')">Logging</button>
                <button type="button" class="tab-button" onclick="showConfigTab('integration')">Integration</button>
              </div>
              
              <!-- General Configuration Tab -->
              <div id="general-config" class="config-tab active">
                <div class="form-row">
                  <div class="form-group">
                    <label for="environment">Environment:</label>
                    <select id="environment" name="environment" required>
                      <option value="development" {% if config.environment == 'development' %}selected{% endif %}>Development</option>
                      <option value="testing" {% if config.environment == 'testing' %}selected{% endif %}>Testing</option>
                      <option value="production" {% if config.environment == 'production' %}selected{% endif %}>Production</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="debug_mode">Debug Mode:</label>
                    <select id="debug_mode" name="debug_mode">
                      <option value="true" {% if config.debug_mode %}selected{% endif %}>Enabled</option>
                      <option value="false" {% if not config.debug_mode %}selected{% endif %}>Disabled</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="host">Host:</label>
                    <input type="text" id="host" name="host" value="{{ config.host or '0.0.0.0' }}" required>
                  </div>
                  
                  <div class="form-group">
                    <label for="port">Port:</label>
                    <input type="number" id="port" name="port" value="{{ config.port or 8000 }}" min="1" max="65535" required>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="max_workers">Maximum Worker Processes:</label>
                  <input type="number" id="max_workers" name="max_workers" 
                         value="{{ config.max_workers or 4 }}" min="1" max="32">
                </div>
              </div>
              
              <!-- Security Configuration Tab -->
              <div id="security-config" class="config-tab">
                <div class="form-row">
                  <div class="form-group">
                    <label for="tls_enabled">TLS/HTTPS Enabled:</label>
                    <select id="tls_enabled" name="tls_enabled">
                      <option value="true" {% if config.tls_enabled %}selected{% endif %}>Enabled</option>
                      <option value="false" {% if not config.tls_enabled %}selected{% endif %}>Disabled</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="cert_validation">Certificate Validation:</label>
                    <select id="cert_validation" name="cert_validation">
                      <option value="strict" {% if config.cert_validation == 'strict' %}selected{% endif %}>Strict</option>
                      <option value="relaxed" {% if config.cert_validation == 'relaxed' %}selected{% endif %}>Relaxed</option>
                      <option value="disabled" {% if config.cert_validation == 'disabled' %}selected{% endif %}>Disabled</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="api_key_required">API Key Required:</label>
                  <select id="api_key_required" name="api_key_required">
                    <option value="true" {% if config.api_key_required %}selected{% endif %}>Required</option>
                    <option value="false" {% if not config.api_key_required %}selected{% endif %}>Optional</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="session_timeout">Session Timeout (minutes):</label>
                  <input type="number" id="session_timeout" name="session_timeout" 
                         value="{{ config.session_timeout or 30 }}" min="5" max="480">
                </div>
              </div>
              
              <!-- Logging Configuration Tab -->
              <div id="logging-config" class="config-tab">
                <div class="form-row">
                  <div class="form-group">
                    <label for="log_level">Log Level:</label>
                    <select id="log_level" name="log_level" required>
                      <option value="DEBUG" {% if config.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                      <option value="INFO" {% if config.log_level == 'INFO' %}selected{% endif %}>INFO</option>
                      <option value="WARNING" {% if config.log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                      <option value="ERROR" {% if config.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                      <option value="CRITICAL" {% if config.log_level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="log_rotation">Log Rotation:</label>
                    <select id="log_rotation" name="log_rotation">
                      <option value="daily" {% if config.log_rotation == 'daily' %}selected{% endif %}>Daily</option>
                      <option value="weekly" {% if config.log_rotation == 'weekly' %}selected{% endif %}>Weekly</option>
                      <option value="monthly" {% if config.log_rotation == 'monthly' %}selected{% endif %}>Monthly</option>
                      <option value="size" {% if config.log_rotation == 'size' %}selected{% endif %}>By Size</option>
                    </select>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="log_directory">Log Directory:</label>
                  <input type="text" id="log_directory" name="log_directory" 
                         value="{{ config.log_directory or '/var/log/marty' }}" required>
                </div>
                
                <div class="form-group">
                  <label for="max_log_files">Maximum Log Files:</label>
                  <input type="number" id="max_log_files" name="max_log_files" 
                         value="{{ config.max_log_files or 30 }}" min="1" max="365">
                </div>
              </div>
              
              <!-- Integration Configuration Tab -->
              <div id="integration-config" class="config-tab">
                <div class="form-group">
                  <label for="openxpki_url">OpenXPKI URL:</label>
                  <input type="url" id="openxpki_url" name="openxpki_url" 
                         value="{{ config.openxpki_url }}" placeholder="https://openxpki.example.com">
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label for="pkd_sync_enabled">PKD Auto-Sync:</label>
                    <select id="pkd_sync_enabled" name="pkd_sync_enabled">
                      <option value="true" {% if config.pkd_sync_enabled %}selected{% endif %}>Enabled</option>
                      <option value="false" {% if not config.pkd_sync_enabled %}selected{% endif %}>Disabled</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="pkd_sync_interval">Sync Interval (hours):</label>
                    <input type="number" id="pkd_sync_interval" name="pkd_sync_interval" 
                           value="{{ config.pkd_sync_interval or 24 }}" min="1" max="168">
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="notification_email">System Notifications Email:</label>
                  <input type="email" id="notification_email" name="notification_email" 
                         value="{{ config.notification_email }}" 
                         placeholder="admin@example.com">
                </div>
              </div>
            </div>
            
            <div class="config-actions">
              <button type="submit" class="button button-primary">Save Configuration</button>
              <button type="button" class="button" onclick="resetToDefaults()">Reset to Defaults</button>
              <button type="button" class="button" onclick="validateConfiguration()">Validate Configuration</button>
            </div>
          </form>
        </div>
      </div>
    </details>
    
    <!-- System Monitoring -->
    <details>
      <summary>System Monitoring & Logs</summary>
      
      <div class="monitoring-section">
        <!-- Real-time Metrics -->
        <div class="metrics-subsection">
          <h4>Real-time System Metrics</h4>
          <div class="metrics-grid">
            <div class="metric-card">
              <h6>CPU Usage</h6>
              <div class="metric-value">{{ metrics.cpu_usage if metrics else '0' }}%</div>
              <div class="metric-chart">
                <div class="chart-bar" style="width: {{ metrics.cpu_usage if metrics else '0' }}%"></div>
              </div>
            </div>
            
            <div class="metric-card">
              <h6>Memory Usage</h6>
              <div class="metric-value">{{ metrics.memory_usage if metrics else '0' }}%</div>
              <div class="metric-chart">
                <div class="chart-bar" style="width: {{ metrics.memory_usage if metrics else '0' }}%"></div>
              </div>
            </div>
            
            <div class="metric-card">
              <h6>Disk Usage</h6>
              <div class="metric-value">{{ metrics.disk_usage if metrics else '0' }}%</div>
              <div class="metric-chart">
                <div class="chart-bar" style="width: {{ metrics.disk_usage if metrics else '0' }}%"></div>
              </div>
            </div>
            
            <div class="metric-card">
              <h6>Network I/O</h6>
              <div class="metric-value">{{ metrics.network_io if metrics else '0' }} MB/s</div>
              <div class="metric-details">
                <small>In: {{ metrics.network_in if metrics else '0' }} MB/s</small>
                <small>Out: {{ metrics.network_out if metrics else '0' }} MB/s</small>
              </div>
            </div>
          </div>
          
          <button class="button" onclick="toggleMetricsAutoRefresh()">
            <span id="metrics-refresh-text">Enable Auto-refresh</span>
          </button>
        </div>
        
        <!-- Log Viewer -->
        <div class="logs-subsection">
          <h4>System Logs</h4>
          
          <!-- Log Filters -->
          <div class="log-controls">
            <div class="log-filters">
              <div class="form-row">
                <div class="form-group">
                  <label for="log_service">Service:</label>
                  <select id="log_service" name="log_service" onchange="filterLogs()">
                    <option value="">All Services</option>
                    <option value="csca">CSCA Service</option>
                    <option value="document_signer">Document Signer</option>
                    <option value="passport_engine">Passport Engine</option>
                    <option value="inspection_system">Inspection System</option>
                    <option value="mdl_engine">MDL Engine</option>
                    <option value="mdoc_engine">mDoc Engine</option>
                    <option value="dtc_engine">DTC Engine</option>
                    <option value="pkd_service">PKD Service</option>
                    <option value="trust_anchor">Trust Anchor</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="log_level_filter">Level:</label>
                  <select id="log_level_filter" name="log_level" onchange="filterLogs()">
                    <option value="">All Levels</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="log_search">Search:</label>
                  <input type="text" id="log_search" placeholder="Search log messages..." onkeyup="filterLogs()">
                </div>
              </div>
              
              <div class="log-actions">
                <button class="button" onclick="refreshLogs()">Refresh</button>
                <button class="button" onclick="clearLogFilters()">Clear Filters</button>
                <button class="button" onclick="downloadLogs()">Download Logs</button>
              </div>
            </div>
          </div>
          
          <!-- Log Display -->
          <div class="log-viewer">
            <div id="log-entries" class="log-entries">
              {% if log_entries %}
                {% for entry in log_entries %}
                  <div class="log-entry log-{{ entry.level.lower() }}" 
                       data-service="{{ entry.service }}" data-level="{{ entry.level }}">
                    <span class="log-timestamp">{{ entry.timestamp }}</span>
                    <span class="log-service">{{ entry.service }}</span>
                    <span class="log-level">{{ entry.level }}</span>
                    <span class="log-message">{{ entry.message }}</span>
                  </div>
                {% endfor %}
              {% else %}
                <div class="no-logs">No log entries available</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </details>
    
    <!-- Database Management -->
    <details>
      <summary>Database Management</summary>
      
      <div class="database-section">
        <div class="db-operations">
          <h4>Database Operations</h4>
          
          <div class="db-actions-grid">
            <div class="db-action-card">
              <h6>Backup Operations</h6>
              <p>Create and manage database backups</p>
              <div class="action-buttons">
                <button class="button" onclick="createBackup()">Create Backup</button>
                <button class="button" onclick="scheduleBackup()">Schedule Backup</button>
                <button class="button" onclick="viewBackups()">View Backups</button>
              </div>
            </div>
            
            <div class="db-action-card">
              <h6>Maintenance</h6>
              <p>Database optimization and cleanup</p>
              <div class="action-buttons">
                <button class="button" onclick="optimizeDatabase()">Optimize</button>
                <button class="button" onclick="cleanupDatabase()">Cleanup</button>
                <button class="button" onclick="analyzeDatabase()">Analyze</button>
              </div>
            </div>
            
            <div class="db-action-card">
              <h6>Migration</h6>
              <p>Schema migrations and updates</p>
              <div class="action-buttons">
                <button class="button" onclick="checkMigrations()">Check Migrations</button>
                <button class="button" onclick="runMigrations()">Run Migrations</button>
                <button class="button" onclick="rollbackMigration()">Rollback</button>
              </div>
            </div>
            
            <div class="db-action-card">
              <h6>Statistics</h6>
              <p>Database usage and performance stats</p>
              <div class="action-buttons">
                <button class="button" onclick="viewDbStats()">View Statistics</button>
                <button class="button" onclick="runHealthCheck()">Health Check</button>
                <button class="button" onclick="generateReport()">Generate Report</button>
              </div>
            </div>
          </div>
        </div>
        
        {% if db_stats %}
          <div class="db-stats">
            <h4>Database Statistics</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <label>Database Size:</label>
                <span>{{ db_stats.size }}</span>
              </div>
              <div class="stat-item">
                <label>Certificate Records:</label>
                <span>{{ db_stats.certificate_count }}</span>
              </div>
              <div class="stat-item">
                <label>Document Records:</label>
                <span>{{ db_stats.document_count }}</span>
              </div>
              <div class="stat-item">
                <label>Log Entries:</label>
                <span>{{ db_stats.log_count }}</span>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </details>
  </article>
</section>

<script>
let metricsAutoRefresh = false;
let metricsRefreshInterval;

function refreshSystemHealth() {
  window.location.reload();
}

function serviceAction(serviceName, action) {
  if (confirm(`Are you sure you want to ${action} the ${serviceName.replace('_', ' ')} service?`)) {
    fetch(`/admin/service/${serviceName}/${action}`, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`Successfully executed ${action} on ${serviceName}`);
          window.location.reload();
        } else {
          alert(`Failed to ${action} ${serviceName}: ${data.error}`);
        }
      })
      .catch(error => {
        alert(`Error: ${error}`);
      });
  }
}

function bulkServiceAction(action) {
  if (confirm(`Are you sure you want to execute ${action.replace('_', ' ')}?`)) {
    fetch(`/admin/bulk-service/${action}`, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        window.location.reload();
      })
      .catch(error => {
        alert(`Error: ${error}`);
      });
  }
}

function viewServiceLogs(serviceName) {
  window.open(`/admin/logs/${serviceName}`, '_blank');
}

function showConfigTab(tabName) {
  // Hide all config tabs
  const tabs = document.querySelectorAll('.config-tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  
  // Remove active class from all tab buttons
  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(button => button.classList.remove('active'));
  
  // Show selected tab
  document.getElementById(`${tabName}-config`).classList.add('active');
  event.target.classList.add('active');
}

function resetToDefaults() {
  if (confirm('Are you sure you want to reset all configuration to defaults? This action cannot be undone.')) {
    fetch('/admin/reset-config', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        window.location.reload();
      })
      .catch(error => {
        alert(`Error: ${error}`);
      });
  }
}

function validateConfiguration() {
  fetch('/admin/validate-config', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.valid) {
        alert('Configuration is valid!');
      } else {
        alert(`Configuration validation failed: ${data.errors.join(', ')}`);
      }
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
}

function toggleMetricsAutoRefresh() {
  const button = document.getElementById('metrics-refresh-text');
  
  if (metricsAutoRefresh) {
    clearInterval(metricsRefreshInterval);
    metricsAutoRefresh = false;
    button.textContent = 'Enable Auto-refresh';
  } else {
    metricsRefreshInterval = setInterval(() => {
      fetch('/admin/metrics')
        .then(response => response.json())
        .then(data => updateMetrics(data))
        .catch(error => console.error('Metrics update failed:', error));
    }, 5000);
    metricsAutoRefresh = true;
    button.textContent = 'Disable Auto-refresh';
  }
}

function updateMetrics(metrics) {
  // Update metric values and charts
  const metricCards = document.querySelectorAll('.metric-card');
  metricCards.forEach(card => {
    const title = card.querySelector('h6').textContent;
    const valueEl = card.querySelector('.metric-value');
    const chartBar = card.querySelector('.chart-bar');
    
    if (title.includes('CPU') && metrics.cpu_usage) {
      valueEl.textContent = `${metrics.cpu_usage}%`;
      chartBar.style.width = `${metrics.cpu_usage}%`;
    } else if (title.includes('Memory') && metrics.memory_usage) {
      valueEl.textContent = `${metrics.memory_usage}%`;
      chartBar.style.width = `${metrics.memory_usage}%`;
    } else if (title.includes('Disk') && metrics.disk_usage) {
      valueEl.textContent = `${metrics.disk_usage}%`;
      chartBar.style.width = `${metrics.disk_usage}%`;
    } else if (title.includes('Network') && metrics.network_io) {
      valueEl.textContent = `${metrics.network_io} MB/s`;
    }
  });
}

function filterLogs() {
  const service = document.getElementById('log_service').value;
  const level = document.getElementById('log_level_filter').value;
  const search = document.getElementById('log_search').value.toLowerCase();
  
  const entries = document.querySelectorAll('.log-entry');
  entries.forEach(entry => {
    const matchesService = !service || entry.dataset.service === service;
    const matchesLevel = !level || entry.dataset.level === level;
    const matchesSearch = !search || entry.textContent.toLowerCase().includes(search);
    
    entry.style.display = (matchesService && matchesLevel && matchesSearch) ? 'flex' : 'none';
  });
}

function refreshLogs() {
  window.location.reload();
}

function clearLogFilters() {
  document.getElementById('log_service').value = '';
  document.getElementById('log_level_filter').value = '';
  document.getElementById('log_search').value = '';
  filterLogs();
}

function downloadLogs() {
  window.location.href = '/admin/logs/download';
}

function createBackup() {
  if (confirm('Create a new database backup? This may take several minutes.')) {
    fetch('/admin/db/backup', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        alert(`Backup failed: ${error}`);
      });
  }
}

function scheduleBackup() {
  alert('Backup scheduling configuration');
}

function viewBackups() {
  window.open('/admin/backups', '_blank');
}

function optimizeDatabase() {
  if (confirm('Optimize the database? This may temporarily affect performance.')) {
    fetch('/admin/db/optimize', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        alert(`Optimization failed: ${error}`);
      });
  }
}

function cleanupDatabase() {
  if (confirm('Clean up the database? This will remove old logs and temporary data.')) {
    fetch('/admin/db/cleanup', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        alert(`Cleanup failed: ${error}`);
      });
  }
}

function analyzeDatabase() {
  fetch('/admin/db/analyze', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
    })
    .catch(error => {
      alert(`Analysis failed: ${error}`);
    });
}

function checkMigrations() {
  window.open('/admin/migrations', '_blank');
}

function runMigrations() {
  if (confirm('Run pending database migrations? This cannot be undone.')) {
    fetch('/admin/db/migrate', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        alert(`Migration failed: ${error}`);
      });
  }
}

function rollbackMigration() {
  if (confirm('Rollback the last migration? This action cannot be undone.')) {
    fetch('/admin/db/rollback', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
      })
      .catch(error => {
        alert(`Rollback failed: ${error}`);
      });
  }
}

function viewDbStats() {
  window.open('/admin/db/stats', '_blank');
}

function runHealthCheck() {
  fetch('/admin/db/health', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      alert(`Database health: ${data.status}\n${data.details.join('\n')}`);
    })
    .catch(error => {
      alert(`Health check failed: ${error}`);
    });
}

function generateReport() {
  window.open('/admin/reports/generate', '_blank');
}
</script>

<style>
.overview-section {
  margin-bottom: 2rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  text-align: center;
  padding: 1.5rem;
  background-color: var(--background-color);
  border: 1px solid var(--border-color);
  border-radius: 4px;
}

.stat-value {
  font-size: 2em;
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.health-overview {
  border-top: 1px solid var(--border-color);
  padding-top: 2rem;
}

.health-indicators {
  margin: 1rem 0;
}

.health-indicator {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.health-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.health-dot.health-healthy {
  background-color: #4caf50;
}

.health-dot.health-degraded {
  background-color: #ff9800;
}

.health-dot.health-unhealthy {
  background-color: #f44336;
}

.health-dot.health-unknown {
  background-color: #9e9e9e;
}

.service-name {
  flex: 1;
  font-weight: 500;
}

.response-time {
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.services-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.service-card {
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 1rem;
  background-color: var(--background-color);
}

.service-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.service-header h5 {
  margin: 0;
  font-size: 1.1em;
}

.service-status {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: bold;
  text-transform: uppercase;
}

.service-status.status-running {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.service-status.status-stopped {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.service-status.status-starting {
  background-color: rgba(255, 193, 7, 0.2);
  color: #f57c00;
}

.service-status.status-unknown {
  background-color: rgba(158, 158, 158, 0.2);
  color: #424242;
}

.service-details {
  margin-bottom: 1rem;
}

.service-details dl {
  margin: 0;
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0.25rem 0.5rem;
}

.service-details dt {
  font-weight: bold;
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.service-details dd {
  margin: 0;
  font-size: 0.9em;
}

.service-actions {
  display: flex;
  gap: 0.25rem;
  flex-wrap: wrap;
}

.service-actions .button {
  font-size: 0.8em;
  padding: 0.25rem 0.5rem;
}

.bulk-actions {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border-color);
}

.bulk-controls {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.config-tabs {
  margin-top: 1rem;
}

.tab-buttons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.tab-button {
  padding: 0.5rem 1rem;
  border: none;
  background: none;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
}

.tab-button:hover {
  background-color: var(--background-color);
}

.tab-button.active {
  border-bottom-color: var(--primary-color);
  font-weight: bold;
}

.config-tab {
  display: none;
  padding: 1rem;
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.config-tab.active {
  display: block;
}

.config-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  flex-wrap: wrap;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin: 1rem 0;
}

.metric-card {
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 1rem;
  background-color: var(--background-color);
}

.metric-card h6 {
  margin: 0 0 0.5rem 0;
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.metric-value {
  font-size: 1.5em;
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.metric-chart {
  height: 8px;
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  overflow: hidden;
}

.chart-bar {
  height: 100%;
  background-color: var(--primary-color);
  transition: width 0.3s ease;
}

.metric-details {
  display: flex;
  justify-content: space-between;
  margin-top: 0.5rem;
}

.metric-details small {
  color: var(--text-color-secondary);
  font-size: 0.8em;
}

.log-controls {
  margin-bottom: 1rem;
}

.log-filters {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.log-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.log-viewer {
  max-height: 500px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background-color: #1e1e1e;
  color: #ffffff;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  overflow-y: auto;
}

.log-entries {
  padding: 1rem;
}

.log-entry {
  display: flex;
  gap: 1rem;
  padding: 0.25rem 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 0.9em;
  line-height: 1.4;
}

.log-timestamp {
  color: #888;
  min-width: 150px;
}

.log-service {
  color: #4fc3f7;
  min-width: 120px;
  font-weight: bold;
}

.log-level {
  min-width: 70px;
  font-weight: bold;
}

.log-entry.log-debug .log-level {
  color: #9e9e9e;
}

.log-entry.log-info .log-level {
  color: #4caf50;
}

.log-entry.log-warning .log-level {
  color: #ff9800;
}

.log-entry.log-error .log-level {
  color: #f44336;
}

.log-entry.log-critical .log-level {
  color: #e91e63;
  background-color: rgba(233, 30, 99, 0.2);
  padding: 0.1rem 0.3rem;
  border-radius: 2px;
}

.log-message {
  flex: 1;
  color: #ffffff;
}

.no-logs {
  text-align: center;
  color: #888;
  padding: 2rem;
}

.db-actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin: 1rem 0;
}

.db-action-card {
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 1rem;
  background-color: var(--background-color);
}

.db-action-card h6 {
  margin: 0 0 0.5rem 0;
  color: var(--primary-color);
}

.db-action-card p {
  margin: 0 0 1rem 0;
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.action-buttons {
  display: flex;
  gap: 0.25rem;
  flex-wrap: wrap;
}

.action-buttons .button {
  font-size: 0.8em;
  padding: 0.25rem 0.5rem;
}

.db-stats {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid var(--border-color);
}

.db-stats .stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem;
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.stat-item label {
  font-weight: bold;
  color: var(--text-color-secondary);
}

.stat-item span {
  color: var(--primary-color);
  font-weight: bold;
}

.form-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: 200px;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: bold;
  color: var(--text-color-secondary);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 0.95em;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
}
</style>
{% endblock %}