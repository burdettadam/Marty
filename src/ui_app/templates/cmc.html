{% extends "base.html" %}
{% block content %}
<section class="layout-three-column">
  <!-- CMC Creation -->
  <article class="card">
    <header><h2>Create CMC</h2></header>
    <form method="post" action="/cmc/create" class="form">
      <fieldset>
        <legend>Personal Information</legend>
        <label for="document_number">Document Number</label>
        <input id="document_number" name="document_number" placeholder="CMC123456" required>

        <label for="issuing_country">Issuing Country</label>
        <select id="issuing_country" name="issuing_country" required>
          <option value="">Select Country</option>
          <option value="USA">United States</option>
          <option value="CAN">Canada</option>
          <option value="GBR">United Kingdom</option>
          <option value="DEU">Germany</option>
          <option value="FRA">France</option>
          <option value="JPN">Japan</option>
          <option value="AUS">Australia</option>
          <!-- Add more countries as needed -->
        </select>

        <label for="surname">Surname</label>
        <input id="surname" name="surname" placeholder="SMITH" required>

        <label for="given_names">Given Names</label>
        <input id="given_names" name="given_names" placeholder="JOHN MICHAEL" required>

        <label for="nationality">Nationality</label>
        <select id="nationality" name="nationality" required>
          <option value="">Select Nationality</option>
          <option value="USA">United States</option>
          <option value="CAN">Canada</option>
          <option value="GBR">United Kingdom</option>
          <option value="DEU">Germany</option>
          <option value="FRA">France</option>
          <option value="JPN">Japan</option>
          <option value="AUS">Australia</option>
          <!-- Add more countries as needed -->
        </select>

        <label for="date_of_birth">Date of Birth</label>
        <input id="date_of_birth" name="date_of_birth" type="date" required>

        <label for="gender">Gender</label>
        <select id="gender" name="gender" required>
          <option value="">Select Gender</option>
          <option value="M">Male</option>
          <option value="F">Female</option>
          <option value="X">Unspecified</option>
        </select>

        <label for="date_of_expiry">Expiry Date</label>
        <input id="date_of_expiry" name="date_of_expiry" type="date" required>
      </fieldset>

      <fieldset>
        <legend>Employment Information</legend>
        <label for="employer">Employer</label>
        <input id="employer" name="employer" placeholder="AMERICAN AIRLINES" required>

        <label for="crew_id">Crew ID</label>
        <input id="crew_id" name="crew_id" placeholder="AA12345" required>
      </fieldset>

      <fieldset>
        <legend>Security Model</legend>
        <label for="security_model">Security Model</label>
        <select id="security_model" name="security_model" required>
          <option value="">Select Security Model</option>
          <option value="CHIP_LDS">Chip/LDS (Traditional)</option>
          <option value="VDS_NC">VDS-NC Barcode</option>
        </select>

        <div class="checkbox-group">
          <label>
            <input type="checkbox" name="background_check_verified" value="true">
            Background Check Verified
          </label>
        </div>
      </fieldset>

      <button type="submit">Create CMC</button>
    </form>

    {% if create_result %}
      <div class="result-panel">
        <h3>Status: <span class="status-{{ create_result.status|lower }}">{{ create_result.status }}</span></h3>
        {% if create_result.error %}
          <p class="error">{{ create_result.error }}</p>
        {% else %}
          <p><strong>CMC ID:</strong> {{ create_result.cmc_id }}</p>
          <p><strong>Security Model:</strong> {{ create_result.security_model }}</p>
          {% if create_result.td1_mrz %}
            <details>
              <summary>TD-1 MRZ</summary>
              <pre class="mrz-text">{{ create_result.td1_mrz }}</pre>
            </details>
          {% endif %}
          {% if create_result.vds_nc_barcode %}
            <details>
              <summary>VDS-NC Barcode Data</summary>
              <pre class="barcode-text">{{ create_result.vds_nc_barcode }}</pre>
            </details>
          {% endif %}
        {% endif %}
      </div>
    {% endif %}
  </article>

  <!-- CMC Verification -->
  <article class="card">
    <header><h2>Verify CMC</h2></header>
    <form method="post" action="/cmc/verify" class="form">
      <fieldset>
        <legend>Verification Method</legend>
        <div class="radio-group">
          <label>
            <input type="radio" name="verify_method" value="cmc_id" checked>
            CMC ID
          </label>
          <label>
            <input type="radio" name="verify_method" value="td1_mrz">
            TD-1 MRZ
          </label>
          <label>
            <input type="radio" name="verify_method" value="barcode">
            VDS-NC Barcode
          </label>
        </div>
      </fieldset>

      <div id="cmc_id_input" class="input-group">
        <label for="verify_cmc_id">CMC ID</label>
        <input id="verify_cmc_id" name="cmc_id" placeholder="CMC123456">
      </div>

      <div id="td1_mrz_input" class="input-group" style="display:none;">
        <label for="verify_td1_mrz">TD-1 MRZ (3 lines, 30 chars each)</label>
        <textarea id="verify_td1_mrz" name="td1_mrz" rows="3" cols="30" placeholder="IUSACMC123456&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&#10;&lt;&lt;&lt;&lt;&lt;8USA8503150M3012316&lt;&lt;&lt;&lt;&lt;&lt;&#10;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;SMITH&lt;&lt;JOHN&lt;MICH"></textarea>
      </div>

      <div id="barcode_input" class="input-group" style="display:none;">
        <label for="verify_barcode">VDS-NC Barcode Data</label>
        <textarea id="verify_barcode" name="barcode_data" rows="3" placeholder="Base64 encoded VDS-NC barcode data"></textarea>
      </div>

      <fieldset>
        <legend>Verification Options</legend>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" name="check_revocation" value="true" checked>
            Check Revocation Status
          </label>
          <label>
            <input type="checkbox" name="validate_background_check" value="true" checked>
            Validate Background Check
          </label>
        </div>
      </fieldset>

      <button type="submit">Verify CMC</button>
    </form>

    {% if verify_result %}
      <div class="result-panel">
        <h3>Status: <span class="status-{{ 'success' if verify_result.is_valid else 'error' }}">
          {{ 'VALID' if verify_result.is_valid else 'INVALID' }}
        </span></h3>

        {% if verify_result.cmc_data %}
          <div class="cmc-data">
            <h4>CMC Information</h4>
            <p><strong>Document Number:</strong> {{ verify_result.cmc_data.document_number }}</p>
            <p><strong>Name:</strong> {{ verify_result.cmc_data.surname }}, {{ verify_result.cmc_data.given_names }}</p>
            <p><strong>Employer:</strong> {{ verify_result.cmc_data.employer }}</p>
            <p><strong>Crew ID:</strong> {{ verify_result.cmc_data.crew_id }}</p>
            <p><strong>Nationality:</strong> {{ verify_result.cmc_data.nationality }}</p>
            <p><strong>Expiry:</strong> {{ verify_result.cmc_data.date_of_expiry }}</p>
          </div>
        {% endif %}

        {% if verify_result.verification_results %}
          <div class="verification-details">
            <h4>Verification Details</h4>
            {% for check in verify_result.verification_results %}
              <div class="verification-check">
                <span class="check-name">{{ check.check_name }}:</span>
                <span class="check-status status-{{ 'success' if check.passed else 'error' }}">
                  {{ 'PASS' if check.passed else 'FAIL' }}
                </span>
                {% if check.details %}
                  <small class="check-details">{{ check.details }}</small>
                {% endif %}
                {% if check.error_code %}
                  <small class="error-code">Error: {{ check.error_code }}</small>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        {% if verify_result.error_message %}
          <p class="error">{{ verify_result.error_message }}</p>
        {% endif %}
      </div>
    {% endif %}
  </article>

  <!-- CMC Management -->
  <article class="card">
    <header><h2>CMC Management</h2></header>

    <!-- Sign CMC -->
    <form method="post" action="/cmc/sign" class="form">
      <fieldset>
        <legend>Sign CMC</legend>
        <label for="sign_cmc_id">CMC ID</label>
        <input id="sign_cmc_id" name="cmc_id" placeholder="CMC123456" required>

        <label for="signer_id">Signer ID</label>
        <input id="signer_id" name="signer_id" placeholder="SIGNER001" required>

        <button type="submit">Sign CMC</button>
      </fieldset>
    </form>

    {% if sign_result %}
      <div class="result-panel">
        <h3>Signing Status: <span class="status-{{ 'success' if sign_result.success else 'error' }}">
          {{ 'SUCCESS' if sign_result.success else 'FAILED' }}
        </span></h3>
        {% if sign_result.signature_info %}
          <p><strong>Algorithm:</strong> {{ sign_result.signature_info.algorithm }}</p>
          <p><strong>Timestamp:</strong> {{ sign_result.signature_info.timestamp }}</p>
          <p><strong>Signer:</strong> {{ sign_result.signature_info.signer_id }}</p>
        {% endif %}
        {% if sign_result.error_message %}
          <p class="error">{{ sign_result.error_message }}</p>
        {% endif %}
      </div>
    {% endif %}

    <!-- Background Check -->
    <form method="post" action="/cmc/background-check" class="form">
      <fieldset>
        <legend>Background Check</legend>
        <label for="bg_cmc_id">CMC ID</label>
        <input id="bg_cmc_id" name="cmc_id" placeholder="CMC123456" required>

        <label for="check_authority">Check Authority</label>
        <select id="check_authority" name="check_authority" required>
          <option value="">Select Authority</option>
          <option value="ICAO_SECURITY">ICAO Security</option>
          <option value="NATIONAL_SECURITY">National Security</option>
          <option value="AIRLINE_SECURITY">Airline Security</option>
          <option value="PORT_AUTHORITY">Port Authority</option>
        </select>

        <label for="check_reference">Check Reference</label>
        <input id="check_reference" name="check_reference" placeholder="BG123456" required>

        <button type="submit">Run Background Check</button>
      </fieldset>
    </form>

    {% if bg_check_result %}
      <div class="result-panel">
        <h3>Background Check: <span class="status-{{ 'success' if bg_check_result.check_passed else 'error' }}">
          {{ 'PASSED' if bg_check_result.check_passed else 'FAILED' }}
        </span></h3>
        <p><strong>Authority:</strong> {{ bg_check_result.check_authority }}</p>
        <p><strong>Reference:</strong> {{ bg_check_result.check_reference }}</p>
        <p><strong>Date:</strong> {{ bg_check_result.check_date }}</p>
      </div>
    {% endif %}

    <!-- Visa-Free Status -->
    <form method="post" action="/cmc/visa-free-status" class="form">
      <fieldset>
        <legend>Update Visa-Free Status</legend>
        <label for="vf_cmc_id">CMC ID</label>
        <input id="vf_cmc_id" name="cmc_id" placeholder="CMC123456" required>

        <div class="radio-group">
          <label>
            <input type="radio" name="visa_free_eligible" value="true" required>
            Grant Visa-Free Entry
          </label>
          <label>
            <input type="radio" name="visa_free_eligible" value="false" required>
            Revoke Visa-Free Entry
          </label>
        </div>

        <label for="vf_authority">Authority</label>
        <select id="vf_authority" name="authority" required>
          <option value="">Select Authority</option>
          <option value="IMMIGRATION_OFFICE">Immigration Office</option>
          <option value="BORDER_CONTROL">Border Control</option>
          <option value="CUSTOMS_AUTHORITY">Customs Authority</option>
          <option value="AVIATION_AUTHORITY">Aviation Authority</option>
        </select>

        <label for="vf_reason">Reason</label>
        <textarea id="vf_reason" name="reason" rows="2" placeholder="Reason for status change" required></textarea>

        <button type="submit">Update Status</button>
      </fieldset>
    </form>

    {% if visa_free_result %}
      <div class="result-panel">
        <h3>Visa-Free Status: <span class="status-{{ 'success' if visa_free_result.success else 'error' }}">
          {{ 'UPDATED' if visa_free_result.success else 'FAILED' }}
        </span></h3>
        {% if visa_free_result.success %}
          <p><strong>Eligible:</strong> {{ 'Yes' if visa_free_result.visa_free_eligible else 'No' }}</p>
          <p><strong>Updated:</strong> {{ visa_free_result.updated_at }}</p>
        {% endif %}
        {% if visa_free_result.error_message %}
          <p class="error">{{ visa_free_result.error_message }}</p>
        {% endif %}
      </div>
    {% endif %}
  </article>
</section>

<!-- JavaScript for dynamic form controls -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle verification method radio buttons
  const verifyMethodRadios = document.querySelectorAll('input[name="verify_method"]');
  const cmcIdInput = document.getElementById('cmc_id_input');
  const td1MrzInput = document.getElementById('td1_mrz_input');
  const barcodeInput = document.getElementById('barcode_input');

  verifyMethodRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      // Hide all input groups
      cmcIdInput.style.display = 'none';
      td1MrzInput.style.display = 'none';
      barcodeInput.style.display = 'none';

      // Show selected input group
      switch(this.value) {
        case 'cmc_id':
          cmcIdInput.style.display = 'block';
          break;
        case 'td1_mrz':
          td1MrzInput.style.display = 'block';
          break;
        case 'barcode':
          barcodeInput.style.display = 'block';
          break;
      }
    });
  });

  // Auto-format TD-1 MRZ input
  const td1MrzTextarea = document.getElementById('verify_td1_mrz');
  if (td1MrzTextarea) {
    td1MrzTextarea.addEventListener('input', function() {
      let value = this.value.replace(/[^A-Z0-9<]/g, ''); // Only allow valid MRZ characters

      // Format into 3 lines of 30 characters
      if (value.length > 30) {
        value = value.substring(0, 30) + '\n' + value.substring(30);
      }
      if (value.length > 61) {
        value = value.substring(0, 61) + '\n' + value.substring(61);
      }
      if (value.length > 92) {
        value = value.substring(0, 92);
      }

      this.value = value;
    });
  }

  // Set minimum date for date inputs to today
  const dateInputs = document.querySelectorAll('input[type="date"]');
  const today = new Date().toISOString().split('T')[0];
  dateInputs.forEach(input => {
    if (input.name === 'date_of_expiry') {
      input.min = today; // Expiry must be in future
    } else if (input.name === 'date_of_birth') {
      input.max = today; // Birth date must be in past
    }
  });
});
</script>

<style>
.layout-three-column {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1rem;
}

@media (max-width: 1200px) {
  .layout-three-column {
    grid-template-columns: 1fr 1fr;
  }
}

@media (max-width: 768px) {
  .layout-three-column {
    grid-template-columns: 1fr;
  }
}

.radio-group, .checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin: 0.5rem 0;
}

.input-group {
  margin: 1rem 0;
}

.mrz-text, .barcode-text {
  font-family: 'Courier New', monospace;
  font-size: 0.8rem;
  background: #f5f5f5;
  padding: 0.5rem;
  border-radius: 4px;
  white-space: pre;
}

.verification-check {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0.25rem 0;
  padding: 0.25rem;
  border-left: 3px solid transparent;
}

.verification-check .check-name {
  font-weight: bold;
  min-width: 120px;
}

.verification-check .check-details,
.verification-check .error-code {
  margin-left: auto;
  font-style: italic;
  color: #666;
}

.cmc-data {
  background: #f9f9f9;
  padding: 1rem;
  border-radius: 4px;
  margin: 1rem 0;
}

.status-success {
  color: #28a745;
  font-weight: bold;
}

.status-error {
  color: #dc3545;
  font-weight: bold;
}

fieldset {
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 1rem;
  margin: 1rem 0;
}

legend {
  font-weight: bold;
  padding: 0 0.5rem;
}
</style>
{% endblock %}
