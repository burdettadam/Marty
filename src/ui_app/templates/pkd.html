{% extends "base.html" %}
{% block content %}
<section class="grid">
  <article class="card">
    <header>
      <h2>PKD & Master List Management</h2>
    </header>

    <!-- Master List Management Section -->
    <details open>
      <summary>Master List Management</summary>

      <!-- Upload Master List -->
      <div class="upload-section">
        <h4>Upload Master List</h4>
        <form method="post" action="/pkd/upload-masterlist" enctype="multipart/form-data">
          <div class="form-row">
            <div class="form-group">
              <label for="masterlist_file">Master List File:</label>
              <input type="file" id="masterlist_file" name="masterlist_file"
                     accept=".ldif,.xml,.json" required>
              <small class="help-text">Supported formats: LDIF, XML, JSON</small>
            </div>

            <div class="form-group">
              <label for="source_name">Source Name:</label>
              <input type="text" id="source_name" name="source_name"
                     placeholder="ICAO PKD, National PKD, etc." required>
            </div>

            <div class="form-group">
              <label for="format_type">Format Type:</label>
              <select id="format_type" name="format_type" required>
                <option value="">Auto-detect</option>
                <option value="ICAO_LDIF">ICAO LDIF</option>
                <option value="NATIONAL_XML">National XML</option>
                <option value="CUSTOM_JSON">Custom JSON</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="validate_signatures" value="true" checked>
                Validate certificate signatures
              </label>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="update_existing" value="true">
                Update existing certificates
              </label>
            </div>
          </div>

          <button type="submit" class="button button-primary">Upload Master List</button>
        </form>

        {% if upload_result %}
          <div class="result-section">
            <h5>Upload Result</h5>
            {% if upload_result.error %}
              <div class="alert alert-error">{{ upload_result.error }}</div>
            {% else %}
              <div class="alert alert-success">
                <strong>Master List Uploaded Successfully</strong><br>
                <strong>Certificates Imported:</strong> {{ upload_result.certificates_imported }}<br>
                <strong>Total Certificates:</strong> {{ upload_result.total_certificates }}<br>
                {% if upload_result.warnings %}
                  <strong>Warnings:</strong> {{ upload_result.warnings|length }}
                {% endif %}
              </div>
              {% if upload_result.warnings %}
                <details>
                  <summary>View Warnings ({{ upload_result.warnings|length }})</summary>
                  <ul class="warning-list">
                    {% for warning in upload_result.warnings %}
                      <li>{{ warning }}</li>
                    {% endfor %}
                  </ul>
                </details>
              {% endif %}
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Download Master List -->
      <div class="download-section">
        <h4>Download Master List</h4>
        <form method="get" action="/pkd/download-masterlist" class="inline-form">
          <select name="format" required>
            <option value="">Select format...</option>
            <option value="LDIF">ICAO LDIF</option>
            <option value="XML">XML</option>
            <option value="JSON">JSON</option>
            <option value="PEM">PEM Bundle</option>
          </select>

          <select name="filter">
            <option value="">All certificates</option>
            <option value="ACTIVE_ONLY">Active only</option>
            <option value="NON_EXPIRED">Non-expired only</option>
            <option value="RECENT">Recent (30 days)</option>
          </select>

          <button type="submit" class="button">Download</button>
        </form>
      </div>
    </details>

    <!-- Certificate Store Browser -->
    <details>
      <summary>Certificate Store Browser</summary>

      <!-- Search and Filter -->
      <div class="search-section">
        <form method="get" action="/pkd" class="search-form">
          <div class="form-row">
            <div class="form-group">
              <label for="search_query">Search:</label>
              <input type="text" id="search_query" name="search"
                     placeholder="Country code, subject, issuer..."
                     value="{{ search_query }}">
            </div>

            <div class="form-group">
              <label for="country_filter">Country:</label>
              <select id="country_filter" name="country">
                <option value="">All countries</option>
                {% for country in countries %}
                  <option value="{{ country.code }}"
                          {% if country_filter == country.code %}selected{% endif %}>
                    {{ country.code }} - {{ country.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label for="status_filter">Status:</label>
              <select id="status_filter" name="status">
                <option value="">All statuses</option>
                <option value="ACTIVE" {% if status_filter == 'ACTIVE' %}selected{% endif %}>Active</option>
                <option value="EXPIRED" {% if status_filter == 'EXPIRED' %}selected{% endif %}>Expired</option>
                <option value="REVOKED" {% if status_filter == 'REVOKED' %}selected{% endif %}>Revoked</option>
                <option value="SUSPENDED" {% if status_filter == 'SUSPENDED' %}selected{% endif %}>Suspended</option>
              </select>
            </div>
          </div>

          <div class="search-actions">
            <button type="submit" class="button">Search</button>
            <button type="button" class="button" onclick="clearSearch()">Clear</button>
            <button type="button" class="button" onclick="exportResults()">Export Results</button>
          </div>
        </form>
      </div>

      <!-- Certificate List -->
      {% if certificates %}
        <div class="certificates-section">
          <div class="table-header">
            <h5>Certificates ({{ certificates|length }} found)</h5>
            <div class="pagination-info">
              {% if pagination %}
                Showing {{ pagination.start }} - {{ pagination.end }} of {{ pagination.total }}
              {% endif %}
            </div>
          </div>

          <div class="table-container">
            <table class="certificates-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="select-all" onchange="selectAllCertificates()"></th>
                  <th>Country</th>
                  <th>Subject</th>
                  <th>Issuer</th>
                  <th>Valid From</th>
                  <th>Valid To</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for cert in certificates %}
                  <tr class="cert-row cert-{{ cert.status|lower }}">
                    <td>
                      <input type="checkbox" class="cert-checkbox" value="{{ cert.certificate_id }}">
                    </td>
                    <td class="cert-country">
                      <span class="country-flag">{{ cert.country_code }}</span>
                    </td>
                    <td class="cert-subject">{{ cert.subject_name }}</td>
                    <td class="cert-issuer">{{ cert.issuer_name }}</td>
                    <td>{{ cert.valid_from }}</td>
                    <td>{{ cert.valid_to }}</td>
                    <td>
                      <span class="status status-{{ cert.status|lower }}">{{ cert.status }}</span>
                    </td>
                    <td class="cert-actions">
                      <button class="button button-small" onclick="viewCertificate('{{ cert.certificate_id }}')">View</button>
                      <button class="button button-small" onclick="downloadCertificate('{{ cert.certificate_id }}')">Download</button>
                      <button class="button button-small" onclick="validateCertificate('{{ cert.certificate_id }}')">Validate</button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Batch Actions -->
          <div class="batch-actions">
            <button class="button" onclick="downloadSelected()">Download Selected</button>
            <button class="button" onclick="validateSelected()">Validate Selected</button>
            <button class="button button-danger" onclick="deleteSelected()">Delete Selected</button>
          </div>

          <!-- Pagination -->
          {% if pagination %}
            <div class="pagination">
              {% if pagination.has_prev %}
                <a href="?page={{ pagination.prev_page }}&{{ request.query_string.decode() }}" class="button button-small">← Previous</a>
              {% endif %}
              <span class="page-info">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
              {% if pagination.has_next %}
                <a href="?page={{ pagination.next_page }}&{{ request.query_string.decode() }}" class="button button-small">Next →</a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="no-results">
          <p>No certificates found. Try adjusting your search criteria or upload a master list.</p>
        </div>
      {% endif %}
    </details>

    <!-- Synchronization Management -->
    <details open>
      <summary>Synchronization Management</summary>

      <!-- Sync Status -->
      <div class="sync-status">
        <h4>Synchronization Status</h4>
        {% if sync_status %}
          <div class="status-grid">
            {% for source in sync_status.sources %}
              <div class="source-card">
                <div class="source-header">
                  <h6>{{ source.name }}</h6>
                  <span class="sync-status status-{{ source.status|lower }}">{{ source.status }}</span>
                </div>
                <div class="source-details">
                  <dl>
                    <dt>Last Sync:</dt><dd>{{ source.last_sync or "Never" }}</dd>
                    <dt>Certificates:</dt><dd>{{ source.certificate_count or 0 }}</dd>
                    <dt>Errors:</dt><dd>{{ source.error_count or 0 }}</dd>
                  </dl>
                </div>
                <div class="source-actions">
                  <button class="button button-small" onclick="syncSource('{{ source.id }}')">Sync Now</button>
                  <button class="button button-small" onclick="configureSource('{{ source.id }}')">Configure</button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Manual Sync Controls -->
        <div class="sync-controls">
          <form method="post" action="/pkd/sync" class="inline-form">
            <select name="source_id">
              <option value="">All sources</option>
              {% if sync_status %}
                {% for source in sync_status.sources %}
                  <option value="{{ source.id }}">{{ source.name }}</option>
                {% endfor %}
              {% endif %}
            </select>

            <label class="checkbox-label">
              <input type="checkbox" name="force_sync" value="true">
              Force full sync
            </label>

            <button type="submit" class="button button-primary">Start Synchronization</button>
          </form>
        </div>

        {% if sync_result %}
          <div class="result-section sync-result pkd-result result-panel status-panel">
            <h5>Synchronization Result</h5>
            {% if sync_result.error %}
              <div class="alert alert-error">{{ sync_result.error }}</div>
            {% else %}
              <div class="alert alert-success">
                <strong>Synchronization Completed</strong><br>
                <strong>Sources Synced:</strong> {{ sync_result.sources_synced }}<br>
                <strong>Certificates Updated:</strong> {{ sync_result.certificates_updated }}<br>
                <strong>Duration:</strong> {{ sync_result.duration }}
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </details>

    <!-- Statistics and Health -->
    <details>
      <summary>Statistics & Health</summary>

      <div class="stats-grid">
        <div class="stat-card">
          <h6>Certificate Statistics</h6>
          <dl class="stat-list">
            <dt>Total Certificates:</dt><dd>{{ statistics.total_certificates or 0 }}</dd>
            <dt>Active:</dt><dd>{{ statistics.active_certificates or 0 }}</dd>
            <dt>Expired:</dt><dd>{{ statistics.expired_certificates or 0 }}</dd>
            <dt>Revoked:</dt><dd>{{ statistics.revoked_certificates or 0 }}</dd>
          </dl>
        </div>

        <div class="stat-card">
          <h6>Country Distribution</h6>
          <dl class="stat-list">
            {% for country in statistics.top_countries %}
              <dt>{{ country.code }}:</dt><dd>{{ country.count }}</dd>
            {% endfor %}
          </dl>
        </div>

        <div class="stat-card">
          <h6>Expiry Alerts</h6>
          <dl class="stat-list">
            <dt>Expiring in 30 days:</dt><dd class="alert-count">{{ statistics.expiring_30_days or 0 }}</dd>
            <dt>Expiring in 7 days:</dt><dd class="alert-count urgent">{{ statistics.expiring_7_days or 0 }}</dd>
            <dt>Expired today:</dt><dd class="alert-count critical">{{ statistics.expired_today or 0 }}</dd>
          </dl>
        </div>

        <div class="stat-card">
          <h6>System Health</h6>
          <dl class="stat-list">
            <dt>Storage Used:</dt><dd>{{ statistics.storage_used or "N/A" }}</dd>
            <dt>Last Backup:</dt><dd>{{ statistics.last_backup or "Never" }}</dd>
            <dt>Sync Errors (24h):</dt><dd>{{ statistics.sync_errors_24h or 0 }}</dd>
          </dl>
        </div>
      </div>

      <div class="health-actions">
        <button class="button" onclick="refreshStats()">Refresh Statistics</button>
        <button class="button" onclick="performHealthCheck()">Perform Health Check</button>
        <button class="button" onclick="exportReport()">Export Report</button>
      </div>
    </details>
  </article>
</section>

<script>
function clearSearch() {
  window.location.href = '/pkd';
}

function exportResults() {
  const params = new URLSearchParams(window.location.search);
  params.set('export', 'true');
  window.location.href = '/pkd?' + params.toString();
}

function selectAllCertificates() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.cert-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });
}

function getSelectedCertificates() {
  const checkboxes = document.querySelectorAll('.cert-checkbox:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function viewCertificate(certId) {
  window.open(`/pkd/certificate/${certId}`, '_blank');
}

function downloadCertificate(certId) {
  window.location.href = `/pkd/certificate/${certId}/download`;
}

function validateCertificate(certId) {
  // Validate single certificate
  fetch(`/pkd/certificate/${certId}/validate`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      alert(`Validation result: ${data.is_valid ? 'Valid' : 'Invalid'}`);
    })
    .catch(error => {
      alert(`Validation error: ${error}`);
    });
}

function downloadSelected() {
  const selected = getSelectedCertificates();
  if (selected.length === 0) {
    alert('Please select certificates to download');
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/pkd/certificates/download';

  selected.forEach(certId => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'certificate_ids';
    input.value = certId;
    form.appendChild(input);
  });

  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
}

function validateSelected() {
  const selected = getSelectedCertificates();
  if (selected.length === 0) {
    alert('Please select certificates to validate');
    return;
  }

  // Validate selected certificates
  alert(`Validating ${selected.length} certificates...`);
}

function deleteSelected() {
  const selected = getSelectedCertificates();
  if (selected.length === 0) {
    alert('Please select certificates to delete');
    return;
  }

  if (confirm(`Are you sure you want to delete ${selected.length} certificates?`)) {
    // Delete selected certificates
    alert('Delete functionality - to be implemented');
  }
}

function syncSource(sourceId) {
  // Trigger sync for specific source
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/pkd/sync';

  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'source_id';
  input.value = sourceId;

  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}

function configureSource(sourceId) {
  // Open source configuration
  alert(`Configure source: ${sourceId}`);
}

function refreshStats() {
  window.location.reload();
}

function performHealthCheck() {
  alert('Performing system health check...');
}

function exportReport() {
  window.location.href = '/pkd/export/report';
}
</script>

<style>
.upload-section,
.download-section {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.download-section:last-child {
  border-bottom: none;
}

.search-section {
  margin-bottom: 2rem;
}

.search-form {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.search-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.certificates-section {
  margin-bottom: 2rem;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.table-header h5 {
  margin: 0;
}

.pagination-info {
  font-size: 0.9em;
  color: var(--text-color-secondary);
}

.certificates-table {
  width: 100%;
  border-collapse: collapse;
}

.certificates-table th,
.certificates-table td {
  padding: 0.5rem;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.certificates-table th {
  background-color: var(--background-color);
  font-weight: bold;
  position: sticky;
  top: 0;
}

.cert-row.cert-active {
  background-color: rgba(76, 175, 80, 0.05);
}

.cert-row.cert-expired {
  background-color: rgba(244, 67, 54, 0.05);
}

.cert-row.cert-revoked {
  background-color: rgba(158, 158, 158, 0.05);
}

.cert-country {
  font-weight: bold;
  font-family: monospace;
}

.cert-subject,
.cert-issuer {
  font-size: 0.9em;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.cert-actions {
  white-space: nowrap;
}

.cert-actions .button {
  margin-right: 0.25rem;
  margin-bottom: 0.25rem;
}

.batch-actions {
  margin: 1rem 0;
  padding: 1rem;
  background-color: var(--background-color);
  border-radius: 4px;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
}

.page-info {
  font-size: 0.9em;
  color: var(--text-color-secondary);
}

.no-results {
  text-align: center;
  padding: 2rem;
  color: var(--text-color-secondary);
}

.sync-status {
  margin-bottom: 2rem;
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.source-card {
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 1rem;
  background-color: var(--background-color);
}

.source-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.source-header h6 {
  margin: 0;
}

.source-details dl {
  margin: 0 0 1rem 0;
}

.source-details dt {
  font-weight: bold;
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.source-details dd {
  margin: 0 0 0.5rem 0;
}

.source-actions {
  display: flex;
  gap: 0.25rem;
}

.sync-controls {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.stat-card {
  border: 1px solid var(--border-color);
  border-radius: 4px;
  padding: 1rem;
  background-color: var(--background-color);
}

.stat-card h6 {
  margin: 0 0 1rem 0;
  color: var(--primary-color);
  font-weight: bold;
}

.stat-list {
  margin: 0;
}

.stat-list dt {
  font-weight: bold;
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.stat-list dd {
  margin: 0 0 0.5rem 0;
  font-size: 1.1em;
  font-weight: bold;
}

.alert-count.urgent {
  color: #f57c00;
}

.alert-count.critical {
  color: #c62828;
}

.health-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.form-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: 200px;
}

.inline-form {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
}

.inline-form input,
.inline-form select {
  margin-bottom: 0;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.9em;
}

.help-text {
  color: var(--text-color-secondary);
  font-size: 0.85em;
  display: block;
  margin-top: 0.25rem;
}

.warning-list {
  margin: 1rem 0;
  padding-left: 2rem;
}

.warning-list li {
  color: #f57c00;
  margin-bottom: 0.5rem;
}

.result-section {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.alert {
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
}

.alert-success {
  background-color: rgba(76, 175, 80, 0.1);
  border: 1px solid rgba(76, 175, 80, 0.3);
  color: var(--success-color);
}

.alert-error {
  background-color: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  color: var(--error-color);
}

.status {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
  text-transform: uppercase;
}

.status-active,
.sync-status.status-synced {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.status-expired,
.sync-status.status-failed {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.status-revoked,
.status-suspended {
  background-color: rgba(158, 158, 158, 0.2);
  color: #424242;
}

.sync-status.status-syncing,
.sync-status.status-pending {
  background-color: rgba(255, 193, 7, 0.2);
  color: #f57c00;
}
</style>
{% endblock %}
