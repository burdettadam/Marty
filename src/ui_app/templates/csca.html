{% extends "base.html" %}
{% block content %}
<section class="grid">
  <article class="card">
    <header>
      <h2>Certificate Authority (CSCA) Management</h2>
    </header>
    
    <!-- Create Certificate Section -->
    <details open>
      <summary>Create New Certificate</summary>
      <div class="section-actions">
        <a href="#create" id="create-link" class="button button-small">Quick Create</a>
      </div>
      <form method="post" action="/csca/create">
        <div class="form-group">
          <label for="country">Country:</label>
          <input type="text" id="country" name="country" placeholder="US" required>
        </div>
        
        <div class="form-group">
          <label for="organization">Organization:</label>
          <input type="text" id="organization" name="organization" placeholder="Government" required>
        </div>
        
        <div class="form-group">
          <label for="subject_name">Subject Name:</label>
          <input type="text" id="subject_name" name="subject_name" 
                 placeholder="CN=Country CSCA, O=Government, C=XX" value="CN=Test CSCA, O=Test, C=US" required>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="validity_days">Validity (days):</label>
            <input type="number" id="validity_days" name="validity_days" value="3650" min="1" max="7300" required>
          </div>
          
          <div class="form-group">
            <label for="key_algorithm">Key Algorithm:</label>
            <select id="key_algorithm" name="key_algorithm" required>
              <option value="RSA">RSA</option>
              <option value="ECDSA">ECDSA</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="key_size">Key Size:</label>
            <select id="key_size" name="key_size" required>
              <option value="2048">2048 (RSA)</option>
              <option value="4096">4096 (RSA)</option>
              <option value="256">256 (ECDSA)</option>
              <option value="384">384 (ECDSA)</option>
            </select>
          </div>
        </div>
        
        <button type="submit" class="button button-primary">Create Certificate</button>
      </form>
      
      {% if create_result %}
        <div class="result-panel">
          <h4>Create Result</h4>
          {% if create_result.error %}
            <div class="alert alert-error">{{ create_result.error }}</div>
          {% else %}
            <div class="alert alert-success">
              <strong>Certificate Created Successfully</strong><br>
              <strong>ID:</strong> {{ create_result.certificate_id }}<br>
              <strong>Status:</strong> {{ create_result.status }}<br>
              <strong>Organization:</strong> {{ create_result.organization }}<br>
              <strong>Country:</strong> {{ create_result.country }}
            </div>
            {% if create_result.certificate_data %}
              <details>
                <summary>View Certificate Data</summary>
                <pre class="certificate-data">{{ create_result.certificate_data }}</pre>
              </details>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    </details>
    
    <!-- Certificate List Section -->
    <details open>
      <summary>Certificate List</summary>
      {% if certificates %}
        <div class="table-container">
          <table class="certificates-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Issue Date</th>
                <th>Expiry Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for cert in certificates %}
                <tr class="cert-row cert-{{ cert.status|lower }}">
                  <td class="cert-id">{{ cert.certificate_id }}</td>
                  <td class="cert-subject">{{ cert.subject_name }}</td>
                  <td class="cert-status">
                    <span class="status status-{{ cert.status|lower }}">{{ cert.status }}</span>
                  </td>
                  <td class="cert-issue">{{ cert.issue_date }}</td>
                  <td class="cert-expiry">{{ cert.expiry_date }}</td>
                  <td class="cert-actions">
                    {% if cert.status == 'ACTIVE' %}
                      <button class="button button-small" onclick="renewCertificate('{{ cert.certificate_id }}')">Renew</button>
                      <button class="button button-small button-danger" onclick="revokeCertificate('{{ cert.certificate_id }}')">Revoke</button>
                    {% endif %}
                    <button class="button button-small" onclick="viewCertificate('{{ cert.certificate_id }}')">View</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p>No certificates found. Create your first certificate above.</p>
        <button class="button" onclick="checkExpiringCertificates()">Check for Expiring Certificates</button>
      {% endif %}
    </details>
    
    <!-- Certificate Operations Section -->
    <details>
      <summary>Certificate Operations</summary>
      
      <!-- Renew Certificate -->
      <div class="operation-section">
        <h4>Renew Certificate</h4>
        <form method="post" action="/csca/renew" class="inline-form">
          <input type="text" name="certificate_id" placeholder="Certificate ID" required>
          <input type="number" name="validity_days" placeholder="Validity Days" value="3650" required>
          <label class="checkbox-label">
            <input type="checkbox" name="reuse_key" value="true">
            Reuse existing key
          </label>
          <button type="submit" class="button">Renew</button>
        </form>
      </div>
      
      <!-- Revoke Certificate -->
      <div class="operation-section">
        <h4>Revoke Certificate</h4>
        <form method="post" action="/csca/revoke" class="inline-form">
          <input type="text" name="certificate_id" placeholder="Certificate ID" required>
          <select name="revocation_reason" required>
            <option value="">Select reason...</option>
            <option value="KEY_COMPROMISE">Key Compromise</option>
            <option value="SUPERSEDED">Superseded</option>
            <option value="CESSATION_OF_OPERATION">Cessation of Operation</option>
            <option value="UNSPECIFIED">Unspecified</option>
          </select>
          <button type="submit" class="button button-danger">Revoke</button>
        </form>
      </div>
      
      <!-- Check Certificate Status -->
      <div class="operation-section">
        <h4>Check Certificate Status</h4>
        <form method="post" action="/csca/status" class="inline-form">
          <input type="text" name="certificate_id" placeholder="Certificate ID" required>
          <button type="submit" class="button">Check Status</button>
        </form>
      </div>
    </details>
  </article>
</section>

<script>
function renewCertificate(certId) {
  const form = document.querySelector('form[action="/csca/renew"] input[name="certificate_id"]');
  if (form) {
    form.value = certId;
    document.querySelector('details[open] summary').scrollIntoView();
  }
}

function revokeCertificate(certId) {
  if (confirm(`Are you sure you want to revoke certificate ${certId}?`)) {
    const form = document.querySelector('form[action="/csca/revoke"] input[name="certificate_id"]');
    if (form) {
      form.value = certId;
    }
  }
}

function viewCertificate(certId) {
  // This could open a modal or navigate to a detail page
  alert(`Viewing certificate: ${certId}`);
}

function checkExpiringCertificates() {
  window.location.href = '/csca/expiring';
}

// Dynamic key size options based on algorithm
document.getElementById('key_algorithm').addEventListener('change', function() {
  const keySize = document.getElementById('key_size');
  keySize.innerHTML = '';
  
  if (this.value === 'RSA') {
    keySize.innerHTML = '<option value="2048">2048</option><option value="4096">4096</option>';
  } else if (this.value === 'ECDSA') {
    keySize.innerHTML = '<option value="256">256</option><option value="384">384</option>';
  }
});
</script>

<style>
.form-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: 200px;
}

.table-container {
  overflow-x: auto;
}

.certificates-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.certificates-table th,
.certificates-table td {
  padding: 0.5rem;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.certificates-table th {
  background-color: var(--background-color);
  font-weight: bold;
}

.cert-row.cert-active {
  background-color: rgba(76, 175, 80, 0.1);
}

.cert-row.cert-expired {
  background-color: rgba(244, 67, 54, 0.1);
}

.cert-row.cert-revoked {
  background-color: rgba(158, 158, 158, 0.1);
}

.cert-id {
  font-family: monospace;
  font-size: 0.9em;
}

.cert-actions {
  white-space: nowrap;
}

.cert-actions .button {
  margin-right: 0.25rem;
  margin-bottom: 0.25rem;
}

.operation-section {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.operation-section:last-child {
  border-bottom: none;
}

.inline-form {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
}

.inline-form input,
.inline-form select {
  margin-bottom: 0;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.9em;
}

.certificate-data {
  background-color: var(--code-background);
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
  font-size: 0.85em;
  white-space: pre-wrap;
}

.result-section {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.alert {
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
}

.alert-success {
  background-color: rgba(76, 175, 80, 0.1);
  border: 1px solid rgba(76, 175, 80, 0.3);
  color: var(--success-color);
}

.alert-error {
  background-color: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  color: var(--error-color);
}

.status {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
  text-transform: uppercase;
}

.status-active {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.status-expired {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.status-revoked {
  background-color: rgba(158, 158, 158, 0.2);
  color: #424242;
}

.status-pending {
  background-color: rgba(255, 193, 7, 0.2);
  color: #f57c00;
}
</style>
{% endblock %}