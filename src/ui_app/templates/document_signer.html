{% extends "base.html" %}
{% block content %}
<section class="grid">
  <article class="card">
    <header>
      <h2>Document Signer Management</h2>
    </header>

    <!-- Document Signing Section -->
    <details open>
      <summary>Sign Document</summary>
      <form method="post" action="/document-signer/sign" enctype="multipart/form-data">
        <div class="form-group">
          <label for="document_id">Document ID:</label>
          <input type="text" id="document_id" name="document_id"
                 placeholder="DOC-" required>
        </div>

        <div class="form-group">
          <label for="document_file">Document File:</label>
          <input type="file" id="document_file" name="document_file"
                 accept=".pdf,.xml,.json" required>
          <small class="help-text">Supported formats: PDF, XML, JSON</small>
        </div>

        <div class="form-group">
          <label for="signature_type">Signature Type:</label>
          <select id="signature_type" name="signature_type">
            <option value="SOD">SOD (Passport Security Object)</option>
            <option value="MDL">MDL Security Object</option>
            <option value="MDOC">mDoc Security Object</option>
            <option value="DTC">DTC Security Object</option>
            <option value="GENERIC">Generic Document</option>
          </select>
        </div>

        <button type="submit" class="button button-primary">Sign Document</button>
      </form>

      {% if sign_result %}
        <div class="result-section">
          <h4>Signing Result</h4>
          {% if sign_result.error %}
            <div class="alert alert-error">{{ sign_result.error }}</div>
          {% else %}
            <div class="alert alert-success">
              <strong>Document Signed Successfully</strong><br>
              <strong>Document ID:</strong> {{ sign_result.document_id }}<br>
              <strong>Signer ID:</strong> {{ sign_result.signature_info.signer_id }}<br>
              <strong>Signature Date:</strong> {{ sign_result.signature_info.signature_date }}
            </div>
            {% if sign_result.signature_info.signature %}
              <details>
                <summary>View Signature Data</summary>
                <div class="signature-data">
                  <strong>Signature (Base64):</strong>
                  <pre class="signature-hex">{{ sign_result.signature_info.signature | b64encode }}</pre>
                </div>
              </details>
            {% endif %}
          {% endif %}
        </div>
      {% endif %}
    </details>

    <!-- Document Verification Section -->
    <details>
      <summary>Verify Document Signature</summary>
      <form method="post" action="/document-signer/verify" enctype="multipart/form-data">
        <div class="form-group">
          <label for="verify_document_file">Signed Document:</label>
          <input type="file" id="verify_document_file" name="document_file"
                 accept=".pdf,.xml,.json" required>
        </div>

        <div class="form-group">
          <label for="verify_certificate">Verification Certificate (optional):</label>
          <input type="file" id="verify_certificate" name="certificate_file"
                 accept=".pem,.cer,.crt">
          <small class="help-text">Leave empty to use trusted certificate store</small>
        </div>

        <button type="submit" class="button">Verify Signature</button>
      </form>

      {% if verify_result %}
        <div class="result-section">
          <h4>Verification Result</h4>
          {% if verify_result.error %}
            <div class="alert alert-error">{{ verify_result.error }}</div>
          {% else %}
            <div class="alert {% if verify_result.is_valid %}alert-success{% else %}alert-error{% endif %}">
              <strong>Signature {% if verify_result.is_valid %}Valid{% else %}Invalid{% endif %}</strong><br>
              {% if verify_result.signer_info %}
                <strong>Signer:</strong> {{ verify_result.signer_info.subject }}<br>
                <strong>Valid From:</strong> {{ verify_result.signer_info.valid_from }}<br>
                <strong>Valid To:</strong> {{ verify_result.signer_info.valid_to }}
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </details>

    <!-- DSC Management Section -->
    <details>
      <summary>Document Signer Certificate (DSC) Management</summary>

      <div class="dsc-section">
        <h4>Current DSCs</h4>
        {% if dscs %}
          <div class="table-container">
            <table class="dsc-table">
              <thead>
                <tr>
                  <th>Certificate ID</th>
                  <th>Subject</th>
                  <th>Issuer</th>
                  <th>Valid From</th>
                  <th>Valid To</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for dsc in dscs %}
                  <tr class="dsc-row dsc-{{ dsc.status|lower }}">
                    <td class="dsc-id">{{ dsc.certificate_id }}</td>
                    <td class="dsc-subject">{{ dsc.subject }}</td>
                    <td class="dsc-issuer">{{ dsc.issuer }}</td>
                    <td>{{ dsc.valid_from }}</td>
                    <td>{{ dsc.valid_to }}</td>
                    <td>
                      <span class="status status-{{ dsc.status|lower }}">{{ dsc.status }}</span>
                    </td>
                    <td class="dsc-actions">
                      <button class="button button-small" onclick="viewDSC('{{ dsc.certificate_id }}')">View</button>
                      {% if dsc.status == 'ACTIVE' %}
                        <button class="button button-small button-danger" onclick="revokeDSC('{{ dsc.certificate_id }}')">Revoke</button>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>No DSCs found. Request a new DSC from the CSCA service.</p>
        {% endif %}

        <!-- Request New DSC -->
        <div class="operation-section">
          <h5>Request New DSC</h5>
          <form method="post" action="/document-signer/request-dsc">
            <div class="form-row">
              <div class="form-group">
                <label for="dsc_subject">Subject Name:</label>
                <input type="text" id="dsc_subject" name="subject_name"
                       placeholder="CN=Document Signer, O=Government, C=XX" required>
              </div>

              <div class="form-group">
                <label for="dsc_validity">Validity (days):</label>
                <input type="number" id="dsc_validity" name="validity_days" value="365" min="30" max="1095" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="dsc_usage">Key Usage:</label>
                <select id="dsc_usage" name="key_usage" multiple>
                  <option value="digitalSignature" selected>Digital Signature</option>
                  <option value="nonRepudiation" selected>Non Repudiation</option>
                  <option value="keyEncipherment">Key Encipherment</option>
                </select>
              </div>
            </div>

            <button type="submit" class="button">Request DSC</button>
          </form>
        </div>
      </div>
    </details>

    <!-- Signing History Section -->
    <details>
      <summary>Signing History</summary>
      {% if signing_history %}
        <div class="table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Document ID</th>
                <th>Document Type</th>
                <th>Signer ID</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in signing_history %}
                <tr>
                  <td>{{ entry.timestamp }}</td>
                  <td class="doc-id">{{ entry.document_id }}</td>
                  <td>{{ entry.document_type }}</td>
                  <td class="signer-id">{{ entry.signer_id }}</td>
                  <td>
                    <span class="status status-{{ entry.status|lower }}">{{ entry.status }}</span>
                  </td>
                  <td>
                    <button class="button button-small" onclick="viewSigningDetails('{{ entry.id }}')">Details</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p>No signing history available.</p>
      {% endif %}
    </details>
  </article>
</section>

<script>
function viewDSC(certId) {
  // Open DSC details modal or page
  alert(`Viewing DSC: ${certId}`);
}

function revokeDSC(certId) {
  if (confirm(`Are you sure you want to revoke DSC ${certId}?`)) {
    // Submit revocation request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/document-signer/revoke-dsc';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'certificate_id';
    input.value = certId;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  }
}

function viewSigningDetails(entryId) {
  // Open signing details modal
  alert(`Viewing signing details: ${entryId}`);
}

// Preview selected file
document.getElementById('document_file').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    // Generate a document ID suggestion based on file name
    const docId = 'DOC-' + file.name.replace(/\.[^/.]+$/, "").toUpperCase().replace(/[^A-Z0-9]/g, '');
    document.getElementById('document_id').value = docId;
  }
});
</script>

<style>
.dsc-section {
  margin-bottom: 2rem;
}

.dsc-table,
.history-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.dsc-table th,
.dsc-table td,
.history-table th,
.history-table td {
  padding: 0.5rem;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.dsc-table th,
.history-table th {
  background-color: var(--background-color);
  font-weight: bold;
}

.dsc-row.dsc-active {
  background-color: rgba(76, 175, 80, 0.1);
}

.dsc-row.dsc-expired {
  background-color: rgba(244, 67, 54, 0.1);
}

.dsc-row.dsc-revoked {
  background-color: rgba(158, 158, 158, 0.1);
}

.dsc-id,
.signer-id,
.doc-id {
  font-family: monospace;
  font-size: 0.9em;
}

.dsc-actions {
  white-space: nowrap;
}

.dsc-actions .button {
  margin-right: 0.25rem;
}

.signature-data {
  margin-top: 1rem;
}

.signature-hex {
  background-color: var(--code-background);
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
  font-size: 0.85em;
  word-break: break-all;
  max-height: 200px;
  overflow-y: auto;
}

.help-text {
  color: var(--text-color-secondary);
  font-size: 0.85em;
  display: block;
  margin-top: 0.25rem;
}

.form-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: 250px;
}

.operation-section {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.result-section {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.alert {
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
}

.alert-success {
  background-color: rgba(76, 175, 80, 0.1);
  border: 1px solid rgba(76, 175, 80, 0.3);
  color: var(--success-color);
}

.alert-error {
  background-color: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  color: var(--error-color);
}

.status {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
  text-transform: uppercase;
}

.status-active,
.status-success {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.status-expired,
.status-failed,
.status-invalid {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.status-revoked {
  background-color: rgba(158, 158, 158, 0.2);
  color: #424242;
}

.status-pending {
  background-color: rgba(255, 193, 7, 0.2);
  color: #f57c00;
}
</style>
{% endblock %}
