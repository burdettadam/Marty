{% extends "base.html" %}
{% block content %}
<section class="grid">
  <article class="card">
    <header>
      <h2>Mobile Driving License (MDL) Management</h2>
    </header>
    
    <!-- Create MDL Section -->
    <details open>
      <summary>Create Mobile Driving License</summary>
      
      <div class="mdl-creation-section">
        <form method="post" action="/mdl/create" enctype="multipart/form-data" class="comprehensive-form">
          <!-- Personal Information -->
          <div class="form-section">
            <h4>Personal Information</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name" required>
              </div>
              
              <div class="form-group">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name" required>
              </div>
              
              <div class="form-group">
                <label for="middle_name">Middle Name:</label>
                <input type="text" id="middle_name" name="middle_name">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="date_of_birth">Date of Birth:</label>
                <input type="date" id="date_of_birth" name="date_of_birth" required value="1990-01-01">
              </div>
              
              <div class="form-group">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender">
                  <option value="">Select Gender</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                  <option value="X">Other</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="nationality">Nationality:</label>
                <input type="text" id="nationality" name="nationality" placeholder="Country code (e.g., US, CA, GB)">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="height">Height (cm):</label>
                <input type="number" id="height" name="height" min="100" max="250">
              </div>
              
              <div class="form-group">
                <label for="weight">Weight (kg):</label>
                <input type="number" id="weight" name="weight" min="30" max="300">
              </div>
              
              <div class="form-group">
                <label for="eye_color">Eye Color:</label>
                <select id="eye_color" name="eye_color">
                  <option value="">Select Eye Color</option>
                  <option value="BLK">Black</option>
                  <option value="BLU">Blue</option>
                  <option value="BRO">Brown</option>
                  <option value="GRY">Gray</option>
                  <option value="GRN">Green</option>
                  <option value="HAZ">Hazel</option>
                  <option value="MAR">Maroon</option>
                  <option value="PNK">Pink</option>
                  <option value="DIC">Dichromatic</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="portrait">Portrait Photo:</label>
              <input type="file" id="portrait" name="portrait" accept="image/jpeg,image/png" onchange="previewImage(this, 'portrait-preview')">
              <small class="help-text">Upload a passport-style photo (JPEG/PNG, max 2MB)</small>
              <div id="portrait-preview" class="image-preview"></div>
            </div>
          </div>
          
          <!-- License Information -->
          <div class="form-section">
            <h4>License Information</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="license_number">License Number:</label>
                <input type="text" id="license_number" name="license_number" required>
              </div>
              
              <div class="form-group">
                <label for="document_number">Document Number:</label>
                <input type="text" id="document_number" name="document_number">
              </div>
              
              <div class="form-group">
                <label for="issuing_authority">Issuing Authority:</label>
                <input type="text" id="issuing_authority" name="issuing_authority" required value="Test DMV">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="issue_date">Issue Date:</label>
                <input type="date" id="issue_date" name="issue_date" required value="2024-01-01">
              </div>
              
              <div class="form-group">
                <label for="expiry_date">Expiry Date:</label>
                <input type="date" id="expiry_date" name="expiry_date" required value="2028-01-01">
              </div>
            </div>
            
            <!-- License Categories -->
            <div class="form-group">
              <label>License Categories:</label>
              <div class="checkbox-grid">
                <label class="checkbox-label">
                  <input type="checkbox" name="categories" value="A">
                  A - Motorcycles
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="categories" value="B">
                  B - Passenger cars
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="categories" value="C">
                  C - Trucks
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="categories" value="D">
                  D - Buses
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="categories" value="BE">
                  BE - Car with trailer
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="categories" value="CE">
                  CE - Truck with trailer
                </label>
              </div>
            </div>
            
            <!-- Restrictions and Endorsements -->
            <div class="form-row">
              <div class="form-group">
                <label for="restrictions">Restrictions:</label>
                <textarea id="restrictions" name="restrictions" rows="3" 
                          placeholder="e.g., Must wear corrective lenses, Daylight driving only..."></textarea>
              </div>
              
              <div class="form-group">
                <label for="endorsements">Endorsements:</label>
                <textarea id="endorsements" name="endorsements" rows="3" 
                          placeholder="e.g., Motorcycle instructor, Commercial driving..."></textarea>
              </div>
            </div>
          </div>
          
          <!-- Address Information -->
          <div class="form-section">
            <h4>Address Information</h4>
            <div class="form-group">
              <label for="address_line1">Address Line 1:</label>
              <input type="text" id="address_line1" name="address_line1">
            </div>
            
            <div class="form-group">
              <label for="address_line2">Address Line 2:</label>
              <input type="text" id="address_line2" name="address_line2">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="city">City:</label>
                <input type="text" id="city" name="city">
              </div>
              
              <div class="form-group">
                <label for="state_province">State/Province:</label>
                <input type="text" id="state_province" name="state_province">
              </div>
              
              <div class="form-group">
                <label for="postal_code">Postal Code:</label>
                <input type="text" id="postal_code" name="postal_code">
              </div>
              
              <div class="form-group">
                <label for="country">Country:</label>
                <input type="text" id="country" name="country" placeholder="Country code (e.g., US)">
              </div>
            </div>
          </div>
          
          <!-- Security and Compliance -->
          <div class="form-section">
            <h4>Security and Compliance</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="real_id_compliant" value="true">
                  REAL ID Compliant
                </label>
              </div>
              
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="organ_donor" value="true">
                  Organ Donor
                </label>
              </div>
              
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="veteran" value="true">
                  Veteran Status
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="button button-primary">Create Mobile Driving License</button>
            <button type="button" class="button" onclick="resetForm()">Reset Form</button>
            <button type="button" class="button" onclick="saveAsDraft()">Save as Draft</button>
          </div>
        </form>
        
        {% if create_result %}
          <div class="result-panel">
            <h4>MDL Creation Result</h4>
            <div class="result-status">
              <span class="status status-{{ create_result.status|lower }}">{{ create_result.status }}</span>
            </div>
            
            {% if create_result.success %}
              <div class="success-details">
                <dl>
                  <dt>License Number:</dt><dd>{{ create_result.license_number }}</dd>
                  <dt>Document ID:</dt><dd>{{ create_result.mdl_id }}</dd>
                  <dt>Created:</dt><dd>{{ create_result.created_at }}</dd>
                </dl>
                
                <!-- QR Code for the created MDL -->
                <div class="qr-code-section">
                  <h5>QR Code for Mobile Device</h5>
                  <div id="mdl-qr-code" class="qr-code-display"></div>
                  <div class="qr-actions">
                    <button class="button button-small" onclick="downloadQRCode('mdl-qr-code', '{{ create_result.license_number }}')">Download QR</button>
                    <button class="button button-small" onclick="printMDL('{{ create_result.mdl_id }}')">Print MDL</button>
                    <button class="button button-small" onclick="generateSecureLink('{{ create_result.mdl_id }}')">Generate Secure Link</button>
                  </div>
                </div>
                
                <!-- Device Transfer Options -->
                <div class="device-transfer-section">
                  <h5>Device Transfer Options</h5>
                  <div class="transfer-options">
                    <button class="button" onclick="generateTransferCode('{{ create_result.mdl_id }}')">Generate Transfer Code</button>
                    <button class="button" onclick="sendToDevice('{{ create_result.mdl_id }}')">Send to Device</button>
                    <button class="button" onclick="showNFCTransfer('{{ create_result.mdl_id }}')">NFC Transfer</button>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="error-details">
                <p class="error">{{ create_result.error }}</p>
                {% if create_result.validation_errors %}
                  <ul class="validation-errors">
                    {% for error in create_result.validation_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </details>
    
    <!-- MDL Lookup and Verification -->
    <details>
      <summary>MDL Lookup & Verification</summary>
      
      <div class="mdl-lookup-section">
        <div class="lookup-tabs">
          <div class="tab-buttons">
            <button type="button" class="tab-button active" onclick="showLookupTab('license')">By License Number</button>
            <button type="button" class="tab-button" onclick="showLookupTab('document')">By Document ID</button>
            <button type="button" class="tab-button" onclick="showLookupTab('qr')">Scan QR Code</button>
            <button type="button" class="tab-button" onclick="showLookupTab('person')">By Person</button>
          </div>
          
          <!-- License Number Lookup -->
          <div id="license-lookup" class="lookup-tab active">
            <form method="post" action="/mdl/lookup">
              <div class="form-row">
                <div class="form-group">
                  <label for="lookup_license_number">License Number:</label>
                  <input type="text" id="lookup_license_number" name="license_number" required>
                </div>
                
                <div class="form-group">
                  <label for="lookup_issuing_authority">Issuing Authority (optional):</label>
                  <input type="text" id="lookup_issuing_authority" name="issuing_authority">
                </div>
              </div>
              
              <button type="submit" class="button button-primary">Lookup MDL</button>
            </form>
          </div>
          
          <!-- Document ID Lookup -->
          <div id="document-lookup" class="lookup-tab">
            <form method="post" action="/mdl/lookup-by-id">
              <div class="form-group">
                <label for="lookup_document_id">Document ID:</label>
                <input type="text" id="lookup_document_id" name="document_id" required>
              </div>
              
              <button type="submit" class="button button-primary">Lookup by ID</button>
            </form>
          </div>
          
          <!-- QR Code Scan -->
          <div id="qr-lookup" class="lookup-tab">
            <div class="qr-scanner-section">
              <h4>Scan MDL QR Code</h4>
              <div class="qr-scanner-container">
                <div id="qr-reader" class="qr-reader"></div>
                <div class="scanner-controls">
                  <button class="button" onclick="startQRScanner()">Start Camera</button>
                  <button class="button" onclick="stopQRScanner()">Stop Camera</button>
                </div>
              </div>
              
              <div class="manual-qr-input">
                <h5>Or enter QR code data manually:</h5>
                <form method="post" action="/mdl/verify-qr">
                  <div class="form-group">
                    <label for="qr_data">QR Code Data:</label>
                    <textarea id="qr_data" name="qr_data" rows="4" 
                              placeholder="Paste QR code data here..."></textarea>
                  </div>
                  
                  <button type="submit" class="button button-primary">Verify QR Data</button>
                </form>
              </div>
            </div>
          </div>
          
          <!-- Person Lookup -->
          <div id="person-lookup" class="lookup-tab">
            <form method="post" action="/mdl/lookup-by-person">
              <div class="form-row">
                <div class="form-group">
                  <label for="search_first_name">First Name:</label>
                  <input type="text" id="search_first_name" name="first_name" required>
                </div>
                
                <div class="form-group">
                  <label for="search_last_name">Last Name:</label>
                  <input type="text" id="search_last_name" name="last_name" required>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="search_date_of_birth">Date of Birth:</label>
                  <input type="date" id="search_date_of_birth" name="date_of_birth">
                </div>
                
                <div class="form-group">
                  <label for="search_state">State/Province:</label>
                  <input type="text" id="search_state" name="state_province">
                </div>
              </div>
              
              <button type="submit" class="button button-primary">Search</button>
            </form>
          </div>
        </div>
        
        <!-- Lookup Results -->
        {% if lookup_result %}
          <div class="lookup-results">
            {% if lookup_result.error %}
              <div class="error-message">
                <p class="error">{{ lookup_result.error }}</p>
              </div>
            {% elif lookup_result.mdl %}
              <div class="mdl-details">
                <div class="mdl-header">
                  <h4>Mobile Driving License Details</h4>
                  <div class="verification-status">
                    <span class="status status-{{ lookup_result.verification_status|lower }}">
                      {{ lookup_result.verification_status }}
                    </span>
                  </div>
                </div>
                
                <!-- Personal Information -->
                <div class="details-section">
                  <h5>Personal Information</h5>
                  <div class="details-grid">
                    <div class="detail-item">
                      <label>Full Name:</label>
                      <span>{{ lookup_result.mdl.first_name }} {{ lookup_result.mdl.middle_name }} {{ lookup_result.mdl.last_name }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Date of Birth:</label>
                      <span>{{ lookup_result.mdl.date_of_birth }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Gender:</label>
                      <span>{{ lookup_result.mdl.gender }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Height:</label>
                      <span>{{ lookup_result.mdl.height }} cm</span>
                    </div>
                    <div class="detail-item">
                      <label>Weight:</label>
                      <span>{{ lookup_result.mdl.weight }} kg</span>
                    </div>
                    <div class="detail-item">
                      <label>Eye Color:</label>
                      <span>{{ lookup_result.mdl.eye_color }}</span>
                    </div>
                  </div>
                  
                  {% if lookup_result.mdl.portrait %}
                    <div class="portrait-display">
                      <img src="data:image/jpeg;base64,{{ lookup_result.mdl.portrait }}" 
                           alt="License holder photo" class="portrait-image">
                    </div>
                  {% endif %}
                </div>
                
                <!-- License Information -->
                <div class="details-section">
                  <h5>License Information</h5>
                  <div class="details-grid">
                    <div class="detail-item">
                      <label>License Number:</label>
                      <span>{{ lookup_result.mdl.license_number }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Document Number:</label>
                      <span>{{ lookup_result.mdl.document_number }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Issuing Authority:</label>
                      <span>{{ lookup_result.mdl.issuing_authority }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Issue Date:</label>
                      <span>{{ lookup_result.mdl.issue_date }}</span>
                    </div>
                    <div class="detail-item">
                      <label>Expiry Date:</label>
                      <span>{{ lookup_result.mdl.expiry_date }}</span>
                    </div>
                    
                    {% if lookup_result.mdl.categories %}
                      <div class="detail-item full-width">
                        <label>License Categories:</label>
                        <div class="categories-display">
                          {% for category in lookup_result.mdl.categories %}
                            <span class="category-badge">{{ category }}</span>
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  
                  {% if lookup_result.mdl.restrictions %}
                    <div class="detail-item full-width">
                      <label>Restrictions:</label>
                      <span>{{ lookup_result.mdl.restrictions }}</span>
                    </div>
                  {% endif %}
                  
                  {% if lookup_result.mdl.endorsements %}
                    <div class="detail-item full-width">
                      <label>Endorsements:</label>
                      <span>{{ lookup_result.mdl.endorsements }}</span>
                    </div>
                  {% endif %}
                </div>
                
                <!-- Address Information -->
                {% if lookup_result.mdl.address_line1 %}
                  <div class="details-section">
                    <h5>Address Information</h5>
                    <div class="address-display">
                      <div>{{ lookup_result.mdl.address_line1 }}</div>
                      {% if lookup_result.mdl.address_line2 %}
                        <div>{{ lookup_result.mdl.address_line2 }}</div>
                      {% endif %}
                      <div>{{ lookup_result.mdl.city }}, {{ lookup_result.mdl.state_province }} {{ lookup_result.mdl.postal_code }}</div>
                      <div>{{ lookup_result.mdl.country }}</div>
                    </div>
                  </div>
                {% endif %}
                
                <!-- Verification Information -->
                {% if lookup_result.mdl.signature_info %}
                  <div class="details-section">
                    <h5>Digital Signature</h5>
                    <div class="signature-details">
                      <div class="signature-status">
                        <span class="status status-{{ 'valid' if lookup_result.mdl.signature_info.is_valid else 'invalid' }}">
                          {{ 'Valid' if lookup_result.mdl.signature_info.is_valid else 'Invalid' }}
                        </span>
                      </div>
                      <div class="signature-info">
                        <div>Signed by: {{ lookup_result.mdl.signature_info.signer_id }}</div>
                        <div>Signature Date: {{ lookup_result.mdl.signature_info.signature_date }}</div>
                        <div>Algorithm: {{ lookup_result.mdl.signature_info.algorithm }}</div>
                      </div>
                    </div>
                  </div>
                {% endif %}
                
                <!-- Verification Actions -->
                <div class="verification-actions">
                  <h5>Verification Tools</h5>
                  <div class="action-buttons">
                    <button class="button" onclick="verifySignature('{{ lookup_result.mdl.document_id }}')">Verify Digital Signature</button>
                    <button class="button" onclick="checkRevocationStatus('{{ lookup_result.mdl.license_number }}')">Check Revocation Status</button>
                    <button class="button" onclick="validateWithIssuer('{{ lookup_result.mdl.license_number }}', '{{ lookup_result.mdl.issuing_authority }}')">Validate with Issuer</button>
                    <button class="button" onclick="generateVerificationReport('{{ lookup_result.mdl.document_id }}')">Generate Report</button>
                  </div>
                </div>
                
                <!-- Additional Actions -->
                <div class="additional-actions">
                  <button class="button" onclick="generateNewQRCode('{{ lookup_result.mdl.document_id }}')">Generate QR Code</button>
                  <button class="button" onclick="exportMDL('{{ lookup_result.mdl.document_id }}')">Export MDL Data</button>
                  <button class="button" onclick="printVerificationCert('{{ lookup_result.mdl.document_id }}')">Print Verification Certificate</button>
                </div>
              </div>
            {% elif lookup_result.results %}
              <!-- Multiple results for person search -->
              <div class="multiple-results">
                <h4>Search Results ({{ lookup_result.results|length }} found)</h4>
                <div class="results-list">
                  {% for mdl in lookup_result.results %}
                    <div class="result-item">
                      <div class="result-summary">
                        <strong>{{ mdl.first_name }} {{ mdl.last_name }}</strong>
                        <span>License: {{ mdl.license_number }}</span>
                        <span>Issued: {{ mdl.issue_date }}</span>
                      </div>
                      <div class="result-actions">
                        <button class="button button-small" onclick="viewFullMDL('{{ mdl.document_id }}')">View Details</button>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              <div class="no-results">
                <p>No MDL found matching your search criteria.</p>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </details>
    
    <!-- MDL Management -->
    <details>
      <summary>MDL Management & Administration</summary>
      
      <div class="mdl-management-section">
        <!-- Bulk Operations -->
        <div class="bulk-operations">
          <h4>Bulk Operations</h4>
          <div class="bulk-controls">
            <form method="post" action="/mdl/bulk-import" enctype="multipart/form-data">
              <div class="form-group">
                <label for="bulk_file">Import MDL Data (CSV/Excel):</label>
                <input type="file" id="bulk_file" name="bulk_file" accept=".csv,.xlsx,.xls">
              </div>
              
              <div class="bulk-actions">
                <button type="submit" class="button">Import MDL Data</button>
                <button type="button" class="button" onclick="downloadTemplate()">Download Template</button>
                <button type="button" class="button" onclick="exportAllMDLs()">Export All MDLs</button>
              </div>
            </form>
          </div>
        </div>
        
        <!-- Statistics -->
        <div class="mdl-statistics">
          <h4>MDL Statistics</h4>
          {% if mdl_stats %}
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value">{{ mdl_stats.total_mdls }}</div>
                <div class="stat-label">Total MDLs</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">{{ mdl_stats.active_mdls }}</div>
                <div class="stat-label">Active Licenses</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">{{ mdl_stats.expired_mdls }}</div>
                <div class="stat-label">Expired</div>
              </div>
              
              <div class="stat-card">
                <div class="stat-value">{{ mdl_stats.revoked_mdls }}</div>
                <div class="stat-label">Revoked</div>
              </div>
            </div>
          {% endif %}
          
          <button class="button" onclick="generateStatisticsReport()">Generate Detailed Report</button>
        </div>
        
        <!-- Recent Activity -->
        <div class="recent-activity">
          <h4>Recent MDL Activity</h4>
          {% if recent_activity %}
            <div class="activity-list">
              {% for activity in recent_activity %}
                <div class="activity-item">
                  <div class="activity-info">
                    <div class="activity-type">{{ activity.type }}</div>
                    <div class="activity-details">{{ activity.details }}</div>
                    <div class="activity-time">{{ activity.timestamp }}</div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p>No recent activity</p>
          {% endif %}
        </div>
      </div>
    </details>
  </article>
</section>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
let qrScanner = null;

function previewImage(input, previewId) {
  const preview = document.getElementById(previewId);
  
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="image-preview-img">`;
    };
    reader.readAsDataURL(input.files[0]);
  } else {
    preview.innerHTML = '';
  }
}

function resetForm() {
  document.querySelector('.comprehensive-form').reset();
  // Clear image previews
  document.querySelectorAll('.image-preview').forEach(preview => {
    preview.innerHTML = '';
  });
}

function saveAsDraft() {
  const formData = new FormData(document.querySelector('.comprehensive-form'));
  
  fetch('/mdl/save-draft', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    alert(data.message || 'Draft saved successfully');
  })
  .catch(error => {
    alert(`Error saving draft: ${error}`);
  });
}

function showLookupTab(tabName) {
  // Hide all lookup tabs
  document.querySelectorAll('.lookup-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(`${tabName}-lookup`).classList.add('active');
  event.target.classList.add('active');
}

function startQRScanner() {
  const qrReaderElement = document.getElementById('qr-reader');
  
  if (qrScanner) {
    qrScanner.stop();
  }
  
  qrScanner = new Html5Qrcode('qr-reader');
  
  qrScanner.start(
    { facingMode: 'environment' },
    {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    },
    (decodedText, decodedResult) => {
      document.getElementById('qr_data').value = decodedText;
      stopQRScanner();
      // Auto-submit the form
      document.querySelector('#qr-lookup form').submit();
    },
    (error) => {
      // Handle scan errors silently
    }
  ).catch(err => {
    console.error('Error starting QR scanner:', err);
    alert('Unable to access camera. Please check permissions.');
  });
}

function stopQRScanner() {
  if (qrScanner) {
    qrScanner.stop().then(() => {
      qrScanner.clear();
      qrScanner = null;
    });
  }
}

function downloadQRCode(qrElementId, filename) {
  const qrElement = document.getElementById(qrElementId);
  const canvas = qrElement.querySelector('canvas');
  
  if (canvas) {
    const link = document.createElement('a');
    link.download = `mdl_qr_${filename}.png`;
    link.href = canvas.toDataURL();
    link.click();
  }
}

function printMDL(mdlId) {
  window.open(`/mdl/${mdlId}/print`, '_blank');
}

function generateSecureLink(mdlId) {
  fetch(`/mdl/${mdlId}/generate-link`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.secure_link) {
        prompt('Secure verification link:', data.secure_link);
      } else {
        alert('Error generating secure link');
      }
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
}

function generateTransferCode(mdlId) {
  fetch(`/mdl/${mdlId}/transfer-code`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.transfer_code) {
        alert(`Transfer Code: ${data.transfer_code}\nValid for: ${data.expires_in} minutes`);
      } else {
        alert('Error generating transfer code');
      }
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
}

function sendToDevice(mdlId) {
  const phoneNumber = prompt('Enter phone number to send MDL:');
  if (phoneNumber) {
    fetch(`/mdl/${mdlId}/send-to-device`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone_number: phoneNumber })
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
  }
}

function showNFCTransfer(mdlId) {
  alert(`NFC Transfer for MDL ${mdlId}\nBring device close to NFC reader...`);
  // This would trigger NFC transfer functionality
}

function verifySignature(documentId) {
  fetch(`/mdl/${documentId}/verify-signature`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      alert(`Signature verification: ${data.valid ? 'VALID' : 'INVALID'}\n${data.details}`);
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
}

function checkRevocationStatus(licenseNumber) {
  fetch(`/mdl/${licenseNumber}/revocation-status`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      alert(`Revocation status: ${data.status}\nLast checked: ${data.checked_at}`);
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
}

function validateWithIssuer(licenseNumber, authority) {
  fetch(`/mdl/${licenseNumber}/validate-issuer`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ issuing_authority: authority })
  })
  .then(response => response.json())
  .then(data => {
    alert(`Issuer validation: ${data.valid ? 'VALID' : 'INVALID'}\n${data.details}`);
  })
  .catch(error => {
    alert(`Error: ${error}`);
  });
}

function generateVerificationReport(documentId) {
  window.open(`/mdl/${documentId}/verification-report`, '_blank');
}

function generateNewQRCode(documentId) {
  fetch(`/mdl/${documentId}/generate-qr`, { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.qr_code) {
        // Display new QR code
        const qrContainer = document.createElement('div');
        qrContainer.innerHTML = `<h5>New QR Code Generated</h5><div id="new-qr-code"></div>`;
        
        QRCode.toCanvas(qrContainer.querySelector('#new-qr-code'), data.qr_code, (error) => {
          if (!error) {
            document.body.appendChild(qrContainer);
          }
        });
      }
    })
    .catch(error => {
      alert(`Error: ${error}`);
    });
}

function exportMDL(documentId) {
  window.location.href = `/mdl/${documentId}/export`;
}

function printVerificationCert(documentId) {
  window.open(`/mdl/${documentId}/verification-certificate`, '_blank');
}

function viewFullMDL(documentId) {
  window.location.href = `/mdl/view/${documentId}`;
}

function downloadTemplate() {
  window.location.href = '/mdl/bulk-import-template';
}

function exportAllMDLs() {
  window.location.href = '/mdl/export-all';
}

function generateStatisticsReport() {
  window.open('/mdl/statistics-report', '_blank');
}

// Generate QR codes when MDL is created
document.addEventListener('DOMContentLoaded', function() {
  const mdlQrElement = document.getElementById('mdl-qr-code');
  if (mdlQrElement && mdlQrElement.dataset.qrData) {
    QRCode.toCanvas(mdlQrElement, mdlQrElement.dataset.qrData, (error) => {
      if (error) console.error('QR code generation error:', error);
    });
  }
});
</script>

<style>
.comprehensive-form {
  margin-bottom: 2rem;
}

.form-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.form-section h4 {
  margin: 0 0 1rem 0;
  color: var(--primary-color);
  border-bottom: 2px solid var(--primary-color);
  padding-bottom: 0.5rem;
}

.form-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: 200px;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.25rem;
  font-weight: bold;
  color: var(--text-color-secondary);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 0.95em;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.9em;
}

.checkbox-label input[type="checkbox"] {
  width: auto;
}

.help-text {
  color: var(--text-color-secondary);
  font-size: 0.85em;
  display: block;
  margin-top: 0.25rem;
}

.image-preview {
  margin-top: 0.5rem;
}

.image-preview-img {
  max-width: 150px;
  max-height: 150px;
  object-fit: cover;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.form-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
  flex-wrap: wrap;
}

.result-panel {
  margin-top: 2rem;
  padding: 1.5rem;
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.result-status {
  margin-bottom: 1rem;
}

.status {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
  text-transform: uppercase;
}

.status-success {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.status-error {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.status-valid {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.status-invalid {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.success-details dl,
.mdl-details dl {
  margin: 1rem 0;
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 0.25rem 1rem;
}

.success-details dt,
.mdl-details dt {
  font-weight: bold;
  color: var(--text-color-secondary);
}

.success-details dd,
.mdl-details dd {
  margin: 0;
}

.qr-code-section {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.qr-code-display {
  margin: 1rem 0;
  text-align: center;
}

.qr-actions,
.transfer-options,
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.device-transfer-section {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.validation-errors {
  margin: 1rem 0;
  padding-left: 1.5rem;
  color: var(--error-color);
}

.lookup-tabs {
  margin-bottom: 2rem;
}

.tab-buttons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.tab-button {
  padding: 0.5rem 1rem;
  border: none;
  background: none;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
}

.tab-button:hover {
  background-color: var(--background-color);
}

.tab-button.active {
  border-bottom-color: var(--primary-color);
  font-weight: bold;
}

.lookup-tab {
  display: none;
  padding: 1rem;
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.lookup-tab.active {
  display: block;
}

.qr-scanner-container {
  margin: 1rem 0;
}

.qr-reader {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

.scanner-controls {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  margin-top: 1rem;
}

.manual-qr-input {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.lookup-results {
  margin-top: 2rem;
}

.mdl-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.verification-status {
  font-size: 0.9em;
}

.details-section {
  margin-bottom: 2rem;
  padding: 1rem;
  background-color: rgba(255, 255, 255, 0.5);
  border-radius: 4px;
}

.details-section h5 {
  margin: 0 0 1rem 0;
  color: var(--primary-color);
  font-weight: bold;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem;
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.detail-item.full-width {
  grid-column: 1 / -1;
  flex-direction: column;
  gap: 0.5rem;
}

.detail-item label {
  font-weight: bold;
  color: var(--text-color-secondary);
}

.portrait-display {
  text-align: center;
  margin: 1rem 0;
}

.portrait-image {
  max-width: 200px;
  max-height: 200px;
  object-fit: cover;
  border-radius: 4px;
  border: 2px solid var(--border-color);
}

.categories-display {
  display: flex;
  gap: 0.25rem;
  flex-wrap: wrap;
}

.category-badge {
  padding: 0.25rem 0.5rem;
  background-color: var(--primary-color);
  color: white;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: bold;
}

.address-display {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.address-display div {
  margin-bottom: 0.25rem;
}

.signature-details {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.signature-status {
  flex-shrink: 0;
}

.signature-info {
  flex: 1;
}

.signature-info div {
  margin-bottom: 0.25rem;
  font-size: 0.9em;
  color: var(--text-color-secondary);
}

.verification-actions,
.additional-actions {
  margin-top: 2rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.verification-actions h5 {
  margin: 0 0 1rem 0;
}

.multiple-results {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.results-list {
  margin-top: 1rem;
}

.result-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  margin-bottom: 0.5rem;
  background-color: white;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.result-summary {
  flex: 1;
}

.result-summary strong {
  display: block;
  margin-bottom: 0.25rem;
}

.result-summary span {
  display: inline-block;
  margin-right: 1rem;
  font-size: 0.9em;
  color: var(--text-color-secondary);
}

.result-actions {
  flex-shrink: 0;
}

.error-message {
  padding: 1rem;
  background-color: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  border-radius: 4px;
}

.no-results {
  text-align: center;
  padding: 2rem;
  color: var(--text-color-secondary);
  border: 2px dashed var(--border-color);
  border-radius: 4px;
}

.bulk-operations {
  margin-bottom: 2rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid var(--border-color);
}

.bulk-controls {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.bulk-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.mdl-statistics {
  margin-bottom: 2rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid var(--border-color);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 1rem 0;
}

.stat-card {
  text-align: center;
  padding: 1.5rem;
  background-color: var(--background-color);
  border: 1px solid var(--border-color);
  border-radius: 4px;
}

.stat-value {
  font-size: 2em;
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.recent-activity {
  margin-bottom: 2rem;
}

.activity-list {
  background-color: var(--background-color);
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.activity-item {
  padding: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-type {
  font-weight: bold;
  color: var(--primary-color);
  margin-bottom: 0.25rem;
}

.activity-details {
  color: var(--text-color);
  margin-bottom: 0.25rem;
}

.activity-time {
  color: var(--text-color-secondary);
  font-size: 0.85em;
}
</style>
{% endblock %}
