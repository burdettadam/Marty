{% extends "base.html" %}
{% block content %}
<section class="grid">
  <article class="card">
    <header>
      <h2>Digital Travel Credential (DTC) Engine</h2>
    </header>

    <!-- Create DTC Section -->
    <details open>
      <summary>Create Digital Travel Credential</summary>
      <form method="post" action="/dtc/create" id="dtc-form">
        <div class="form-row">
          <div class="form-group">
            <label for="dtc_type">DTC Type:</label>
            <select id="dtc_type" name="dtc_type" required onchange="updateDTCFields()">
              <option value="">Select DTC type...</option>
              <option value="VIRTUAL">Virtual DTC (vDTC)</option>
              <option value="PHYSICAL">Physical DTC (pDTC)</option>
              <option value="TEMPORARY">Temporary DTC (tDTC)</option>
            </select>
            <small class="help-text" id="dtc-type-help">Choose the type of Digital Travel Credential</small>
          </div>

          <div class="form-group">
            <label for="access_control">Access Control:</label>
            <select id="access_control" name="access_control" required>
              <option value="">Select access control...</option>
              <option value="NONE">No Access Control</option>
              <option value="PASSWORD">Password Protected</option>
              <option value="BIOMETRIC">Biometric Protected</option>
              <option value="CERTIFICATE">Certificate Based</option>
            </select>
          </div>
        </div>

        <!-- Passport Information -->
        <fieldset class="passport-info">
          <legend>Source Passport Information</legend>
          <div class="form-row">
            <div class="form-group">
              <label for="passport_number">Passport Number:</label>
              <input type="text" id="passport_number" name="passport_number"
                     placeholder="P12345678" pattern="[A-Z][0-9]{8}" required>
            </div>

            <div class="form-group">
              <label for="issuing_country">Issuing Country:</label>
              <input type="text" id="issuing_country" name="issuing_country"
                     placeholder="NZL" pattern="[A-Z]{3}" title="3-letter country code" required>
            </div>

            <div class="form-group">
              <label for="passport_expiry">Passport Expiry:</label>
              <input type="date" id="passport_expiry" name="passport_expiry" required>
            </div>
          </div>
        </fieldset>

        <!-- Personal Information -->
        <fieldset class="personal-info">
          <legend>Personal Information</legend>
          <div class="form-row">
            <div class="form-group">
              <label for="given_name">Given Name:</label>
              <input type="text" id="given_name" name="given_name" required>
            </div>

            <div class="form-group">
              <label for="family_name">Family Name:</label>
              <input type="text" id="family_name" name="family_name" required>
            </div>

            <div class="form-group">
              <label for="date_of_birth">Date of Birth:</label>
              <input type="date" id="date_of_birth" name="date_of_birth" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="nationality">Nationality:</label>
              <input type="text" id="nationality" name="nationality"
                     placeholder="NZL" pattern="[A-Z]{3}" title="3-letter country code" required>
            </div>

            <div class="form-group">
              <label for="sex">Sex:</label>
              <select id="sex" name="sex">
                <option value="">Not specified</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
                <option value="X">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="place_of_birth">Place of Birth:</label>
              <input type="text" id="place_of_birth" name="place_of_birth">
            </div>
          </div>
        </fieldset>

        <!-- DTC Specific Settings -->
        <fieldset class="dtc-settings" id="dtc-settings">
          <legend>DTC Settings</legend>

          <!-- Validity Period -->
          <div class="form-row">
            <div class="form-group">
              <label for="validity_start">Validity Start:</label>
              <input type="date" id="validity_start" name="validity_start" required>
            </div>

            <div class="form-group">
              <label for="validity_end">Validity End:</label>
              <input type="date" id="validity_end" name="validity_end" required>
            </div>
          </div>

          <!-- Travel Purpose (for temporary DTCs) -->
          <div class="form-group" id="travel-purpose-group" style="display: none;">
            <label for="travel_purpose">Travel Purpose:</label>
            <select id="travel_purpose" name="travel_purpose">
              <option value="">Select purpose...</option>
              <option value="BUSINESS">Business</option>
              <option value="TOURISM">Tourism</option>
              <option value="TRANSIT">Transit</option>
              <option value="EMERGENCY">Emergency</option>
              <option value="MEDICAL">Medical</option>
            </select>
          </div>

          <!-- Access Control Settings -->
          <div id="access-control-settings">
            <div class="form-group" id="password-group" style="display: none;">
              <label for="access_password">Access Password:</label>
              <input type="password" id="access_password" name="access_password">
            </div>

            <div class="form-group" id="biometric-group" style="display: none;">
              <label for="biometric_type">Biometric Type:</label>
              <select id="biometric_type" name="biometric_type">
                <option value="FINGERPRINT">Fingerprint</option>
                <option value="FACE">Facial Recognition</option>
                <option value="IRIS">Iris</option>
              </select>
            </div>
          </div>
        </fieldset>

        <button type="submit" class="button button-primary">Create DTC</button>
      </form>

      {% if create_result %}
        <div class="result-section">
          <h4>Creation Result</h4>
          {% if create_result.error %}
            <div class="alert alert-error">{{ create_result.error }}</div>
          {% else %}
            <div class="alert alert-success">
              <strong>DTC Created Successfully</strong><br>
              <strong>DTC ID:</strong> {{ create_result.dtc_id }}<br>
              <strong>Type:</strong> {{ create_result.dtc_type }}<br>
              <strong>Status:</strong> {{ create_result.status }}
            </div>
            <div class="dtc-actions">
              <button class="button" onclick="generateQRCode('{{ create_result.dtc_id }}')">Generate QR Code</button>
              <button class="button" onclick="transferToDevice('{{ create_result.dtc_id }}')">Transfer to Device</button>
              <button class="button" onclick="linkToPassport('{{ create_result.dtc_id }}')">Link to Passport</button>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </details>

    <!-- Lookup DTC Section -->
    <details>
      <summary>Lookup Digital Travel Credential</summary>
      <form method="post" action="/dtc/lookup">
        <div class="form-row">
          <div class="form-group">
            <label for="lookup_dtc_id">DTC ID:</label>
            <input type="text" id="lookup_dtc_id" name="dtc_id"
                   placeholder="DTC-" required>
          </div>

          <div class="form-group">
            <label for="lookup_passport_number">Or Passport Number:</label>
            <input type="text" id="lookup_passport_number" name="passport_number"
                   placeholder="P12345678" pattern="[A-Z][0-9]{8}">
          </div>
        </div>

        <button type="submit" class="button">Lookup DTC</button>
      </form>

      {% if lookup_result %}
        <div class="result-section">
          <h4>Lookup Result</h4>
          {% if lookup_result.error %}
            <div class="alert alert-error">{{ lookup_result.error }}</div>
          {% else %}
            <div class="dtc-details">
              <div class="dtc-header">
                <h5>{{ lookup_result.dtc_type }} - {{ lookup_result.dtc_id }}</h5>
                <span class="status status-{{ lookup_result.status|lower }}">{{ lookup_result.status }}</span>
              </div>

              <div class="dtc-info-grid">
                <div class="info-section">
                  <h6>DTC Information</h6>
                  <dl>
                    <dt>DTC ID:</dt><dd>{{ lookup_result.dtc_id }}</dd>
                    <dt>Type:</dt><dd>{{ lookup_result.dtc_type }}</dd>
                    <dt>Access Control:</dt><dd>{{ lookup_result.access_control }}</dd>
                    <dt>Valid From:</dt><dd>{{ lookup_result.validity_start }}</dd>
                    <dt>Valid To:</dt><dd>{{ lookup_result.validity_end }}</dd>
                    {% if lookup_result.travel_purpose %}<dt>Travel Purpose:</dt><dd>{{ lookup_result.travel_purpose }}</dd>{% endif %}
                  </dl>
                </div>

                <div class="info-section">
                  <h6>Source Passport</h6>
                  <dl>
                    <dt>Passport Number:</dt><dd>{{ lookup_result.passport_number }}</dd>
                    <dt>Issuing Country:</dt><dd>{{ lookup_result.issuing_country }}</dd>
                    <dt>Passport Expiry:</dt><dd>{{ lookup_result.passport_expiry }}</dd>
                    {% if lookup_result.passport_status %}<dt>Passport Status:</dt><dd>{{ lookup_result.passport_status }}</dd>{% endif %}
                  </dl>
                </div>

                <div class="info-section">
                  <h6>Personal Information</h6>
                  <dl>
                    <dt>Name:</dt><dd>{{ lookup_result.given_name }} {{ lookup_result.family_name }}</dd>
                    <dt>Date of Birth:</dt><dd>{{ lookup_result.date_of_birth }}</dd>
                    <dt>Nationality:</dt><dd>{{ lookup_result.nationality }}</dd>
                    {% if lookup_result.sex %}<dt>Sex:</dt><dd>{{ lookup_result.sex }}</dd>{% endif %}
                    {% if lookup_result.place_of_birth %}<dt>Place of Birth:</dt><dd>{{ lookup_result.place_of_birth }}</dd>{% endif %}
                  </dl>
                </div>

                {% if lookup_result.signature_info %}
                <div class="info-section">
                  <h6>Signature Information</h6>
                  <dl>
                    <dt>Signer ID:</dt><dd>{{ lookup_result.signature_info.signer_id }}</dd>
                    <dt>Signature Date:</dt><dd>{{ lookup_result.signature_info.signature_date }}</dd>
                    <dt>Valid:</dt><dd>{{ "Yes" if lookup_result.signature_info.is_valid else "No" }}</dd>
                  </dl>
                </div>
                {% endif %}
              </div>

              <div class="dtc-actions">
                <button class="button" onclick="generateQRCode('{{ lookup_result.dtc_id }}')">Generate QR Code</button>
                <button class="button" onclick="transferToDevice('{{ lookup_result.dtc_id }}')">Transfer to Device</button>
                <button class="button" onclick="verifyDTC('{{ lookup_result.dtc_id }}')">Verify DTC</button>
                {% if lookup_result.status == 'ACTIVE' %}
                  <button class="button button-danger" onclick="revokeDTC('{{ lookup_result.dtc_id }}')">Revoke DTC</button>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </details>

    <!-- DTC Management Section -->
    <details>
      <summary>DTC Management Operations</summary>

      <!-- Link to Passport -->
      <div class="operation-section">
        <h4>Link DTC to Passport</h4>
        <form method="post" action="/dtc/link-passport" class="inline-form">
          <input type="text" name="dtc_id" placeholder="DTC ID" required>
          <input type="text" name="passport_number" placeholder="Passport Number" pattern="[A-Z][0-9]{8}" required>
          <select name="link_type" required>
            <option value="">Link type...</option>
            <option value="STRONG">Strong Binding</option>
            <option value="WEAK">Weak Binding</option>
          </select>
          <button type="submit" class="button">Link to Passport</button>
        </form>
      </div>

      <!-- Revoke DTC -->
      <div class="operation-section">
        <h4>Revoke DTC</h4>
        <form method="post" action="/dtc/revoke" class="inline-form">
          <input type="text" name="dtc_id" placeholder="DTC ID" required>
          <select name="revocation_reason" required>
            <option value="">Select reason...</option>
            <option value="PASSPORT_LOST">Passport Lost/Stolen</option>
            <option value="PASSPORT_EXPIRED">Passport Expired</option>
            <option value="USER_REQUEST">User Request</option>
            <option value="SECURITY_COMPROMISE">Security Compromise</option>
            <option value="ADMIN_DECISION">Administrative Decision</option>
          </select>
          <button type="submit" class="button button-danger">Revoke DTC</button>
        </form>
      </div>

      <!-- Verify DTC -->
      <div class="operation-section">
        <h4>Verify DTC</h4>
        <form method="post" action="/dtc/verify" class="inline-form">
          <input type="text" name="dtc_id" placeholder="DTC ID" required>
          <input type="text" name="verification_context" placeholder="Context (optional)">
          <button type="submit" class="button">Verify DTC</button>
        </form>
      </div>
    </details>

    <!-- QR Code Generation -->
    <details>
      <summary>QR Code & Sharing</summary>
      <div class="qr-section">
        <form method="post" action="/dtc/generate-qr" class="qr-form">
          <div class="form-row">
            <div class="form-group">
              <label for="qr_dtc_id">DTC ID:</label>
              <input type="text" id="qr_dtc_id" name="dtc_id" required>
            </div>

            <div class="form-group">
              <label for="qr_format">QR Code Format:</label>
              <select id="qr_format" name="format">
                <option value="STANDARD">Standard QR</option>
                <option value="COMPACT">Compact QR</option>
                <option value="SECURE">Secure QR</option>
              </select>
            </div>

            <div class="form-group">
              <label for="qr_size">Size:</label>
              <select id="qr_size" name="size">
                <option value="SMALL">Small (200x200)</option>
                <option value="MEDIUM" selected>Medium (400x400)</option>
                <option value="LARGE">Large (800x800)</option>
              </select>
            </div>
          </div>

          <button type="submit" class="button">Generate QR Code</button>
        </form>

        {% if qr_result %}
          <div class="qr-result">
            <h5>Generated QR Code</h5>
            {% if qr_result.qr_code_data %}
              <div class="qr-display">
                <img src="data:image/png;base64,{{ qr_result.qr_code_data }}" alt="DTC QR Code">
              </div>
              <div class="qr-actions">
                <button class="button" onclick="downloadQR()">Download QR Code</button>
                <button class="button" onclick="printQR()">Print QR Code</button>
                <button class="button" onclick="copyQRData()">Copy QR Data</button>
              </div>
            {% endif %}
            {% if qr_result.error %}
              <div class="alert alert-error">{{ qr_result.error }}</div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </details>
  </article>
</section>

<script>
function updateDTCFields() {
  const dtcType = document.getElementById('dtc_type').value;
  const helpText = document.getElementById('dtc-type-help');
  const travelPurposeGroup = document.getElementById('travel-purpose-group');

  // Update help text
  switch (dtcType) {
    case 'VIRTUAL':
      helpText.textContent = 'Virtual DTC - Standalone credential not requiring physical passport';
      travelPurposeGroup.style.display = 'none';
      break;
    case 'PHYSICAL':
      helpText.textContent = 'Physical DTC - Used alongside physical passport';
      travelPurposeGroup.style.display = 'none';
      break;
    case 'TEMPORARY':
      helpText.textContent = 'Temporary DTC - Limited validity for specific purpose';
      travelPurposeGroup.style.display = 'block';
      document.getElementById('travel_purpose').required = true;
      break;
    default:
      helpText.textContent = 'Choose the type of Digital Travel Credential';
      travelPurposeGroup.style.display = 'none';
  }
}

// Update access control settings
document.getElementById('access_control').addEventListener('change', function() {
  const accessControl = this.value;
  const passwordGroup = document.getElementById('password-group');
  const biometricGroup = document.getElementById('biometric-group');

  // Hide all groups first
  passwordGroup.style.display = 'none';
  biometricGroup.style.display = 'none';

  // Show relevant group
  switch (accessControl) {
    case 'PASSWORD':
      passwordGroup.style.display = 'block';
      document.getElementById('access_password').required = true;
      break;
    case 'BIOMETRIC':
      biometricGroup.style.display = 'block';
      document.getElementById('biometric_type').required = true;
      break;
    default:
      // No additional fields needed
      break;
  }
});

function generateQRCode(dtcId) {
  document.getElementById('qr_dtc_id').value = dtcId;
  const qrSection = document.querySelector('details:has(.qr-section)');
  qrSection.open = true;
  qrSection.scrollIntoView();
}

function transferToDevice(dtcId) {
  alert(`Initiating device transfer for DTC: ${dtcId}`);
}

function linkToPassport(dtcId) {
  const form = document.querySelector('form[action="/dtc/link-passport"] input[name="dtc_id"]');
  if (form) {
    form.value = dtcId;
  }
}

function verifyDTC(dtcId) {
  window.open(`/dtc/${dtcId}/verify`, '_blank');
}

function revokeDTC(dtcId) {
  if (confirm(`Are you sure you want to revoke DTC ${dtcId}?`)) {
    const form = document.querySelector('form[action="/dtc/revoke"] input[name="dtc_id"]');
    if (form) {
      form.value = dtcId;
    }
  }
}

function downloadQR() {
  // Download QR code image
  const img = document.querySelector('.qr-display img');
  if (img) {
    const link = document.createElement('a');
    link.download = 'dtc-qr-code.png';
    link.href = img.src;
    link.click();
  }
}

function printQR() {
  // Print QR code
  const qrDisplay = document.querySelector('.qr-display');
  if (qrDisplay) {
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>DTC QR Code</title></head><body>');
    printWindow.document.write(qrDisplay.innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }
}

function copyQRData() {
  // Copy QR data to clipboard
  alert('QR data copying functionality - to be implemented');
}

// Auto-generate validity dates
document.getElementById('dtc_type').addEventListener('change', function() {
  const validityStart = document.getElementById('validity_start');
  const validityEnd = document.getElementById('validity_end');
  const today = new Date();

  validityStart.value = today.toISOString().split('T')[0];

  let endDate = new Date(today);
  switch (this.value) {
    case 'TEMPORARY':
      endDate.setDate(today.getDate() + 30); // 30 days for temporary
      break;
    case 'VIRTUAL':
      endDate.setFullYear(today.getFullYear() + 5); // 5 years for virtual
      break;
    case 'PHYSICAL':
      endDate.setFullYear(today.getFullYear() + 10); // 10 years for physical
      break;
  }

  validityEnd.value = endDate.toISOString().split('T')[0];
});
</script>

<style>
.passport-info,
.personal-info,
.dtc-settings {
  margin-bottom: 1.5rem;
  border: 1px solid var(--border-color);
  padding: 1rem;
  border-radius: 4px;
}

.passport-info legend,
.personal-info legend,
.dtc-settings legend {
  font-weight: bold;
  padding: 0 0.5rem;
}

.form-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.form-row .form-group {
  flex: 1;
  min-width: 200px;
}

.help-text {
  color: var(--text-color-secondary);
  font-size: 0.85em;
  display: block;
  margin-top: 0.25rem;
}

.dtc-details {
  background-color: var(--background-color);
  border-radius: 4px;
  padding: 1rem;
}

.dtc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border-color);
}

.dtc-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.info-section {
  background-color: rgba(255, 255, 255, 0.5);
  padding: 1rem;
  border-radius: 4px;
}

.info-section h6 {
  margin: 0 0 0.5rem 0;
  color: var(--primary-color);
  font-weight: bold;
}

.info-section dl {
  margin: 0;
}

.info-section dt {
  font-weight: bold;
  color: var(--text-color-secondary);
  font-size: 0.9em;
}

.info-section dd {
  margin: 0 0 0.5rem 0;
  color: var(--text-color);
}

.dtc-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.operation-section {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.operation-section:last-child {
  border-bottom: none;
}

.inline-form {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
}

.inline-form input,
.inline-form select {
  margin-bottom: 0;
}

.qr-section {
  margin-top: 1rem;
}

.qr-form {
  margin-bottom: 1rem;
}

.qr-result {
  background-color: var(--background-color);
  padding: 1rem;
  border-radius: 4px;
  text-align: center;
}

.qr-display {
  margin: 1rem 0;
}

.qr-display img {
  border: 1px solid var(--border-color);
  border-radius: 4px;
}

.qr-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

.result-section {
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.alert {
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1rem;
}

.alert-success {
  background-color: rgba(76, 175, 80, 0.1);
  border: 1px solid rgba(76, 175, 80, 0.3);
  color: var(--success-color);
}

.alert-error {
  background-color: rgba(244, 67, 54, 0.1);
  border: 1px solid rgba(244, 67, 54, 0.3);
  color: var(--error-color);
}

.status {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
  text-transform: uppercase;
}

.status-active {
  background-color: rgba(76, 175, 80, 0.2);
  color: #2e7d32;
}

.status-revoked,
.status-expired {
  background-color: rgba(244, 67, 54, 0.2);
  color: #c62828;
}

.status-pending {
  background-color: rgba(255, 193, 7, 0.2);
  color: #f57c00;
}

.status-suspended {
  background-color: rgba(158, 158, 158, 0.2);
  color: #424242;
}
</style>
{% endblock %}
