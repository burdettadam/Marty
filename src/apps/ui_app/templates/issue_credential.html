{% extends "base.html" %}

{% block title %}Issue Credential - {{ ui_title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Issue New Credential</h4>
            </div>
            <div class="card-body">
                <form method="post" action="/issue">
                    <div class="mb-3">
                        <label for="credential_type" class="form-label">Credential Type *</label>
                        <select class="form-select" id="credential_type" name="credential_type" required onchange="toggleFields()">
                            <option value="">Select credential type...</option>
                            {% for cred_type in credential_types %}
                            <option value="{{ cred_type.value }}">{{ cred_type.label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subject_id" class="form-label">Subject ID *</label>
                                <input type="text" class="form-control" id="subject_id" name="subject_id"
                                       placeholder="demo-user-001" required>
                                <div class="form-text">Unique identifier for the credential subject</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="holder_name" class="form-label">Holder Name *</label>
                                <input type="text" class="form-control" id="holder_name" name="holder_name"
                                       placeholder="John Doe" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="birth_date" class="form-label">Birth Date *</label>
                        <input type="date" class="form-control" id="birth_date" name="birth_date" required>
                    </div>

                    <div class="mb-3">
                        <label for="document_number" class="form-label">Document Number *</label>
                        <input type="text" class="form-control" id="document_number" name="document_number"
                               placeholder="P123456789" required>
                        <div class="form-text" id="document_help">Document or license number</div>
                    </div>

                    <!-- Passport-specific fields -->
                    <div id="passport_fields" style="display: none;">
                        <div class="mb-3">
                            <label for="issuing_country" class="form-label">Issuing Country</label>
                            <select class="form-select" id="issuing_country" name="issuing_country">
                                <option value="">Select country...</option>
                                {% for country in countries %}
                                <option value="{{ country }}">{{ country }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- MDL-specific fields -->
                    <div id="mdl_fields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="issuing_state" class="form-label">Issuing State</label>
                                    <select class="form-select" id="issuing_state" name="issuing_state">
                                        <option value="">Select state...</option>
                                        {% for state in states %}
                                        <option value="{{ state }}">{{ state }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="license_class" class="form-label">License Class</label>
                                    <select class="form-select" id="license_class" name="license_class">
                                        <option value="C">C - Regular Driver License</option>
                                        <option value="M">M - Motorcycle</option>
                                        <option value="CDL">CDL - Commercial Driver License</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Demo Note:</strong> This form will create a verifiable credential using the Marty platform's
                        issuer API. The credential will include selective disclosure capabilities for privacy protection.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary" onclick="fillSampleData()">Fill Sample Data</button>
                        <button type="submit" class="btn btn-primary">Issue Credential</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleFields() {
    const credentialType = document.getElementById('credential_type').value;
    const passportFields = document.getElementById('passport_fields');
    const mdlFields = document.getElementById('mdl_fields');
    const documentHelp = document.getElementById('document_help');

    // Hide all fields first
    passportFields.style.display = 'none';
    mdlFields.style.display = 'none';

    // Show relevant fields based on credential type
    if (credentialType === 'PassportCredential') {
        passportFields.style.display = 'block';
        documentHelp.textContent = 'Passport number (e.g., P123456789)';
    } else if (credentialType === 'MDLCredential') {
        mdlFields.style.display = 'block';
        documentHelp.textContent = 'Driver license number (e.g., DL123456789)';
    } else if (credentialType === 'mDocCredential') {
        documentHelp.textContent = 'Document ID (e.g., MDOC001)';
    }
}

function fillSampleData() {
    const credentialType = document.getElementById('credential_type').value;

    if (!credentialType) {
        alert('Please select a credential type first');
        return;
    }

    // Fill common fields
    document.getElementById('subject_id').value = 'demo-user-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    document.getElementById('holder_name').value = 'Demo User';
    document.getElementById('birth_date').value = '1990-01-15';

    if (credentialType === 'PassportCredential') {
        document.getElementById('document_number').value = 'P' + Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
        document.getElementById('issuing_country').value = 'USA';
    } else if (credentialType === 'MDLCredential') {
        document.getElementById('document_number').value = 'DL' + Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
        document.getElementById('issuing_state').value = 'California';
        document.getElementById('license_class').value = 'C';
    } else if (credentialType === 'mDocCredential') {
        document.getElementById('document_number').value = 'MDOC' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    }
}
</script>
{% endblock %}
