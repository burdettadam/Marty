# Default values for credential-ledger.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: marty/credential-ledger
  tag: "latest"
  pullPolicy: IfNotPresent

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: "credential-ledger"

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8081"
  prometheus.io/path: "/metrics"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
    - ALL

service:
  type: ClusterIP
  http:
    port: 8089
    targetPort: 8089
  grpc:
    port: 9089
    targetPort: 9089
  metrics:
    port: 8081
    targetPort: 8081

# Environment configuration
env:
  # General service environment
  LOG_LEVEL: "INFO"
  SERVICE_NAME: "credential-ledger"
  SERVICE_VERSION: "1.0.0"
  
  # Health check configuration
  HEALTH_CHECK_PORT: "8081"
  METRICS_PORT: "8081"

# gRPC TLS Configuration
grpc:
  tls:
    # Enable TLS for gRPC connections
    enabled: true
    
    # mTLS configuration
    mtls: true
    require_client_auth: true
    
    # Server certificate configuration
    server_cert: "/etc/tls/server/tls.crt"
    server_key: "/etc/tls/server/tls.key"
    
    # Client CA for mTLS (when require_client_auth or mtls is true)
    client_ca: "/etc/tls/ca/ca.crt"
    
    # Client certificate configuration (for outbound connections)
    client_cert: "/etc/tls/client/tls.crt"
    client_key: "/etc/tls/client/tls.key"
    
    # Secret names for TLS certificates
    secrets:
      server:
        name: "credential-ledger-server-tls"
        cert_key: "tls.crt"
        key_key: "tls.key"
      client:
        name: "credential-ledger-client-tls"
        cert_key: "tls.crt"
        key_key: "tls.key"
      ca:
        name: "credential-ledger-ca"
        cert_key: "ca.crt"

# Database configuration
database:
  # Database connection string
  dsn: "postgresql://marty:password@postgres.marty.svc.cluster.local:5432/credential_ledger"
  
  # Individual connection parameters (for services that need them separately)
  host: "postgres.marty.svc.cluster.local"
  port: 5432
  name: "credential_ledger"
  user: "marty"
  password: ""
  
  # Database secret configuration
  passwordSecret:
    name: "credential-ledger-db-secret"
    key: "password"
  
  # Connection pool settings
  pool:
    min_size: 1
    max_size: 10
    max_overflow: 20

# Object Storage configuration (S3-compatible)
objectStorage:
  enabled: true
  endpoint: "minio.marty.svc.cluster.local:9000"
  bucket: "credential-ledger-storage"
  region: "us-east-1"
  use_ssl: false
  
  # Credentials configuration
  access_key: ""
  secret_key: ""
  
  # Secret configuration
  credentialsSecret:
    name: "credential-ledger-storage-secret"
    access_key_key: "access-key"
    secret_key_key: "secret-key"

# Key Vault configuration (HashiCorp Vault or Azure Key Vault)
keyVault:
  enabled: false
  
  # Vault type: "hashicorp" or "azure"
  type: "hashicorp"
  
  # HashiCorp Vault configuration
  hashicorp:
    endpoint: "vault.marty.svc.cluster.local:8200"
    auth_method: "kubernetes"
    role: "credential-ledger"
    mount_path: "auth/kubernetes"
    secrets_path: "secret/credential-ledger"
  
  # Azure Key Vault configuration
  azure:
    vault_url: "https://marty-keyvault.vault.azure.net/"
    tenant_id: ""
    client_id: ""
    client_secret: ""
    
    # Secret configuration for Azure credentials
    credentialsSecret:
      name: "credential-ledger-keyvault-secret"
      tenant_id_key: "tenant-id"
      client_id_key: "client-id"
      client_secret_key: "client-secret"

# Event Bus configuration (Kafka/NATS/RabbitMQ)
eventBus:
  # Event bus type: "kafka", "nats", or "rabbitmq"
  type: "kafka"
  
  # Kafka configuration
  kafka:
    brokers: "kafka.marty.svc.cluster.local:9092"
    topic_prefix: "credential-ledger."
    consumer_group: "credential-ledger-consumers"
    
    # Security configuration
    security:
      enabled: false
      protocol: "SASL_SSL"
      sasl_mechanism: "PLAIN"
      username: ""
      password: ""
      
      # Secret configuration
      credentialsSecret:
        name: "credential-ledger-kafka-secret"
        username_key: "username"
        password_key: "password"
  
  # NATS configuration
  nats:
    servers: "nats.marty.svc.cluster.local:4222"
    subject_prefix: "credential-ledger."
    
    # Security configuration
    security:
      enabled: false
      username: ""
      password: ""
      
      # Secret configuration
      credentialsSecret:
        name: "credential-ledger-nats-secret"
        username_key: "username"
        password_key: "password"
  
  # RabbitMQ configuration
  rabbitmq:
    host: "rabbitmq.marty.svc.cluster.local"
    port: 5672
    vhost: "/"
    exchange_prefix: "credential-ledger."
    
    # Security configuration
    username: ""
    password: ""
    
    # Secret configuration
    credentialsSecret:
      name: "credential-ledger-rabbitmq-secret"
      username_key: "username"
      password_key: "password"

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# Ingress configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: "credential-ledger.chart-example.local"
      paths:
        - path: /
          pathType: Prefix
  tls: []

# Autoscaling configuration
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

# Service-specific configuration
serviceConfig:
  # Credential ledger specific settings
  ledger:
    retention_days: 365
    batch_size: 100

# Migration job configuration
migration:
  enabled: true
  image:
    repository: marty/credential-ledger
    tag: "latest"
    pullPolicy: IfNotPresent
  
  # Alembic configuration
  alembic:
    command: ["python", "-m", "alembic", "upgrade", "head"]
    config_file: "/app/alembic.ini"
  
  # Job configuration
  job:
    restartPolicy: Never
    backoffLimit: 3
    activeDeadlineSeconds: 600
    ttlSecondsAfterFinished: 86400
  
  # Resources for migration job
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# Monitoring configuration
monitoring:
  # ServiceMonitor for Prometheus
  serviceMonitor:
    enabled: true
    interval: 30s
    path: /metrics
    port: metrics
    labels: {}
    
  # PodMonitor for metrics sidecars
  podMonitor:
    enabled: false
    interval: 30s
    path: /metrics
    port: metrics-sidecar
    labels: {}

# Service mesh configuration
serviceMesh:
  enabled: false
  type: "istio"  # "istio" or "linkerd"
  
  # Istio configuration
  istio:
    # Automatically inject sidecar
    injection: enabled
    
    # mTLS configuration
    mtls:
      mode: "STRICT"
    
    # Traffic policy
    trafficPolicy:
      tls:
        mode: "ISTIO_MUTUAL"
  
  # Linkerd configuration
  linkerd:
    # Automatically inject sidecar
    injection: enabled
    
    # mTLS is always enabled in Linkerd
    # Additional configurations can be added here
